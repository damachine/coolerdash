name: Multi-Distribution Installation Test

on:
  push:
    paths:
      - "VERSION"
    branches:
      - master
  workflow_dispatch: # Allows manual execution
permissions:
  contents: read

jobs:
  make-install:
    name: Test 'make install' on ${{ matrix.name }}
    runs-on: ubuntu-latest

    strategy:
      fail-fast: false # Test all distros even if one fails
      matrix:
        include:
          # Ubuntu/Debian family
          - distro: "ubuntu:24.04"
            name: "Ubuntu 24.04 LTS"
            pre_install: "apt-get update"
            install_deps: "apt-get install -y sudo systemd libcairo2-dev libcurl4-openssl-dev libinih-dev build-essential pkg-config libjansson-dev fonts-roboto file"

          - distro: "debian:13"
            name: "Debian 13 (Trixie)"
            pre_install: "apt-get update"
            install_deps: "apt-get install -y sudo systemd libcairo2-dev libcurl4-openssl-dev libinih-dev build-essential pkg-config libjansson-dev fonts-roboto file"

          # Fedora family (independent from RHEL)
          - distro: "fedora:42"
            name: "Fedora 42"
            pre_install: "dnf update -y"
            install_deps: "dnf install -y sudo systemd cairo-devel libcurl-devel inih-devel gcc make pkg-config jansson-devel google-roboto-fonts file"

          # RHEL/CentOS family (RHEL-compatible)
          - distro: "quay.io/centos/centos:stream9"
            name: "CentOS Stream 9 (RHEL 9 compatible)"
            pre_install: "dnf update -y && dnf install -y epel-release && dnf config-manager --set-enabled crb && dnf makecache"
            install_deps: "dnf install -y sudo systemd cairo-devel libcurl-devel inih-devel gcc make pkg-config jansson-devel google-roboto-fonts file"

          # openSUSE family
          - distro: "opensuse/tumbleweed"
            name: "openSUSE Tumbleweed"
            pre_install: "zypper refresh"
            install_deps: "zypper install -y tar sudo systemd cairo-devel libcurl-devel libinih-devel gcc make pkg-config libjansson-devel google-roboto-fonts file"

          - distro: "opensuse/leap:16.0"
            name: "openSUSE Leap 16.0"
            pre_install: "zypper refresh"
            install_deps: "zypper install -y sudo systemd cairo-devel libcurl-devel libinih-devel gcc make pkg-config libjansson-devel google-roboto-fonts file"

    container:
      image: ${{ matrix.distro }}
      options: --privileged # For systemctl and make install

    steps:
      - name: Checkout CoolerDash code
        uses: actions/checkout@b4ffde65f46336ab88eb53be808477a3936bae11 # v4.1.1

      - name: Update package manager
        run: ${{ matrix.pre_install }}

      - name: Install build dependencies
        run: ${{ matrix.install_deps }}

      - name: Test make install
        run: |
          echo "ðŸš€ Testing 'make install' on ${{ matrix.name }}"

          # Create a safe install simulation
          # (since we're in a container, we can't test all systemd services)
          export DESTDIR=/tmp/install-test
          mkdir -p /tmp/install-test

          echo "Running make install with DESTDIR=/tmp/install-test"
          SUDO="" REALOS=no make install || {
            echo "âŒ make install failed"
            echo "Exit code: $?"
            echo "Checking if binary exists:"
            ls -la bin/coolerdash || echo "No binary found"
            exit 1
          }

          # Check if all expected files were installed
          echo "ðŸ“ Checking installed files:"
          find /tmp/install-test -type f -name "*coolerdash*" | head -10

          # Check binary (Plugin mode: /etc/coolercontrol/plugins/coolerdash/)
          if [ -f "/tmp/install-test/etc/coolercontrol/plugins/coolerdash/coolerdash" ]; then
            echo "âœ… Binary installed correctly (plugin mode)"
            file /tmp/install-test/etc/coolercontrol/plugins/coolerdash/coolerdash
          else
            echo "âŒ Binary not found at expected location"
            find /tmp/install-test -name "coolerdash" -type f
            exit 1
          fi

          # Check plugin files
          if [ -f "/tmp/install-test/etc/coolercontrol/plugins/coolerdash/config.json" ]; then
            echo "âœ… Config file installed (plugin mode)"
          else
            echo "âŒ Config file not found"
            exit 1
          fi

          # Check manifest.toml
          if [ -f "/tmp/install-test/etc/coolercontrol/plugins/coolerdash/manifest.toml" ]; then
            echo "âœ… Plugin manifest installed"
          else
            echo "âŒ Plugin manifest not found"
            exit 1
          fi

          # Check documentation
          if [ -f "/tmp/install-test/usr/share/man/man1/coolerdash.1" ]; then
            echo "âœ… Manual page installed"
          else
            echo "âš ï¸  Manual page not found"
          fi

          echo "âœ… Installation test completed on ${{ matrix.name }}"

  # Additional test for Arch Linux (your development system)
  arch-install:
    name: Test on Arch Linux (Reference)
    runs-on: ubuntu-latest
    container:
      image: archlinux:latest
      options: --privileged

    steps:
      - name: Checkout code
        uses: actions/checkout@b4ffde65f46336ab88eb53be808477a3936bae11 # v4.1.1

      - name: Setup Arch Linux
        run: |
          pacman -Syu --noconfirm
          pacman -S --noconfirm cairo libcurl-gnutls libinih gcc make pkg-config jansson ttf-roboto sudo systemd

      - name: Test make install on Arch
        run: |
          echo "ðŸš€ Testing 'make install' on Arch Linux (reference system)"

          export DESTDIR=/tmp/install-test
          mkdir -p /tmp/install-test
          SUDO="" REALOS=no make install

          # Verify plugin installation
          if [ -f "/tmp/install-test/etc/coolercontrol/plugins/coolerdash/coolerdash" ]; then
            echo "âœ… Plugin binary installed"
            file /tmp/install-test/etc/coolercontrol/plugins/coolerdash/coolerdash
          else
            echo "âŒ Plugin binary not found"
            find /tmp/install-test -name "coolerdash" -type f
            exit 1
          fi

          echo "âœ… Arch Linux installation test completed (reference)"

  # Summary report
  installation-summary:
    name: Multi-Distribution Installation Test Summary
    runs-on: ubuntu-latest
    needs: [make-install, arch-install]
    if: always() # Runs even if tests fail

    steps:
      - name: Create summary report
        run: |
          echo "## ðŸš€ CoolerDash Multi-Distribution Installation Test Results" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### Tested Distributions:" >> $GITHUB_STEP_SUMMARY
          echo "- **Ubuntu**: 24.04 LTS" >> $GITHUB_STEP_SUMMARY
          echo "- **Debian**: 13 (Trixie)" >> $GITHUB_STEP_SUMMARY
          echo "- **Fedora**: 42" >> $GITHUB_STEP_SUMMARY
          echo "- **RHEL-compatible**: CentOS Stream 9" >> $GITHUB_STEP_SUMMARY
          echo "- **openSUSE**: Tumbleweed, Leap 16.0" >> $GITHUB_STEP_SUMMARY
          echo "- **Arch Linux**: Latest (reference)" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### Test Coverage:" >> $GITHUB_STEP_SUMMARY
          echo "âœ… Installation process (make install)" >> $GITHUB_STEP_SUMMARY
          echo "âœ… File placement verification" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "ðŸ”— **View detailed logs above for distribution-specific results**" >> $GITHUB_STEP_SUMMARY
