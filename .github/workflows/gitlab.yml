name: Sync to GitLab

permissions:
  contents: read

on:
  push:
    branches: [ main ]
  release:
    types: [ published ]
  workflow_dispatch:  # Allows manual execution

jobs:
  sync:
    name: Synchronize with GitLab
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout repository
      uses: actions/checkout@b4ffde65f46336ab88eb53be808477a3936bae11  # v4.1.1
      with:
        fetch-depth: 0  # Fetch complete history for proper sync
        
    - name: Configure Git
      run: |
        git config --global user.name "GitHub Actions"
        git config --global user.email "actions@github.com"
        
    - name: Add GitLab remote and push
      env:
        GITLAB_TOKEN: ${{ secrets.GITLAB_TOKEN }}
      run: |
        if [ -z "$GITLAB_TOKEN" ]; then
          echo "❌ GITLAB_TOKEN is not set in repository secrets"
          echo "Please add your GitLab Personal Access Token to GitHub Secrets as 'GITLAB_TOKEN'"
          exit 1
        fi
        
        # Add GitLab remote with token authentication
        git remote add gitlab https://oauth2:${GITLAB_TOKEN}@gitlab.com/damachine/coolerdash.git
        git remote -v
        
        echo "🔄 Synchronizing branches to GitLab..."
        git push gitlab --all --force
        
        echo "🏷️ Synchronizing tags to GitLab..."
        git push gitlab --tags --force
        
        echo "✅ Synchronization completed successfully"
        
    - name: Create sync summary
      if: success()
      run: |
        echo "## 🔄 GitLab Synchronization Report" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "### Synchronized Content:" >> $GITHUB_STEP_SUMMARY
        echo "- **Repository**: coolerdash" >> $GITHUB_STEP_SUMMARY
        echo "- **Target**: GitLab (gitlab.com/damachine/coolerdash)" >> $GITHUB_STEP_SUMMARY
        echo "- **Branches**: All branches synced" >> $GITHUB_STEP_SUMMARY
        echo "- **Tags**: All tags synced" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "🎯 **GitLab repository is now up-to-date with GitHub**" >> $GITHUB_STEP_SUMMARY
        
    - name: Error summary
      if: failure()
      run: |
        echo "## ❌ GitLab Synchronization Failed" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "### Troubleshooting Steps:" >> $GITHUB_STEP_SUMMARY
        echo "1. **Check GitLab Token**: Ensure GITLAB_TOKEN secret is set" >> $GITHUB_STEP_SUMMARY
        echo "2. **Token Permissions**: Token needs 'write_repository' scope" >> $GITHUB_STEP_SUMMARY
        echo "3. **Repository Access**: Verify you have push access to GitLab repo" >> $GITHUB_STEP_SUMMARY