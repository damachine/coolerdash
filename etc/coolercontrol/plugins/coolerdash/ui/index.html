<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>CoolerDash Settings</title>
    <script type="text/javascript" src="cc-plugin-lib.js" onerror="console.warn('cc-plugin-lib.js not found, using fallback')"></script>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }

        :root {
            --bg-primary: rgb(26, 26, 46);
            --bg-secondary: rgb(22, 33, 62);
            --bg-card: rgb(30, 35, 55);
            --bg-input: rgb(20, 28, 48);
            --border: rgb(45, 66, 99);
            --border-light: rgb(55, 76, 109);
            --text: rgb(234, 234, 234);
            --text-dim: rgb(140, 145, 165);
            --text-muted: rgb(100, 105, 125);
            --accent: rgb(233, 69, 96);
            --accent-hover: rgb(255, 89, 116);
            --accent-glow: rgba(233, 69, 96, 0.15);
            --success: rgb(34, 197, 94);
            --radius: 10px;
            --radius-sm: 6px;
            --shadow: 0 4px 20px rgba(0, 0, 0, 0.25);
            --shadow-sm: 0 2px 8px rgba(0, 0, 0, 0.2);
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, 'Inter', sans-serif;
            background: linear-gradient(135deg, var(--bg-secondary) 0%, var(--bg-primary) 100%);
            color: var(--text);
            line-height: 1.6;
            padding: 24px;
            min-height: 100vh;
        }

        .container {
            max-width: 920px;
            margin: 0 auto;
        }

        /* Header */
        .header {
            background: var(--bg-card);
            border-radius: var(--radius);
            padding: 28px 32px;
            margin-bottom: 20px;
            box-shadow: var(--shadow);
            border: 1px solid var(--border);
        }

        .header h1 {
            font-size: 26px;
            font-weight: 700;
            margin-bottom: 10px;
            display: flex;
            align-items: center;
            gap: 12px;
            background: linear-gradient(135deg, var(--text) 0%, var(--text-dim) 100%);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
        }

        .header p {
            color: var(--text-dim);
            font-size: 14px;
        }

        /* Tabs */
        .tabs {
            display: flex;
            gap: 6px;
            margin-bottom: 20px;
            background: var(--bg-card);
            padding: 10px;
            border-radius: var(--radius);
            box-shadow: var(--shadow-sm);
            overflow-x: auto;
            flex-wrap: wrap;
            border: 1px solid var(--border);
        }

        .tab {
            flex: 1;
            min-width: 85px;
            padding: 11px 14px;
            background: transparent;
            border: none;
            border-radius: var(--radius-sm);
            color: var(--text-dim);
            cursor: pointer;
            font-size: 13px;
            font-weight: 500;
            transition: all 0.2s ease;
            white-space: nowrap;
        }

        .tab:hover {
            background: var(--accent-glow);
            color: var(--text);
        }

        .tab.active {
            background: var(--accent);
            color: white;
            box-shadow: 0 2px 8px rgba(233, 69, 96, 0.4);
        }

        /* Panel */
        .panel {
            display: none;
            background: var(--bg-card);
            border-radius: var(--radius);
            padding: 28px 32px;
            box-shadow: var(--shadow);
            animation: fadeIn 0.3s ease;
            border: 1px solid var(--border);
        }

        .panel.active {
            display: block;
        }

        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(8px); }
            to { opacity: 1; transform: translateY(0); }
        }

        /* Section Title */
        .section-title {
            margin: 32px 0 20px;
            font-size: 13px;
            font-weight: 600;
            color: var(--accent);
            border-bottom: 1px solid var(--border);
            padding-bottom: 10px;
            text-transform: uppercase;
            letter-spacing: 1px;
        }

        .section-title:first-child {
            margin-top: 0;
        }

        /* Form Elements */
        .form-group {
            margin-bottom: 0;
        }

        .form-label {
            display: block;
            font-weight: 500;
            margin-bottom: 8px;
            font-size: 13px;
            color: var(--text);
        }

        .form-hint {
            display: block;
            font-size: 11px;
            color: var(--text-muted);
            margin-bottom: 8px;
        }

        .form-control {
            width: 100%;
            padding: 11px 14px;
            background: var(--bg-input);
            border: 1px solid var(--border);
            border-radius: var(--radius-sm);
            color: var(--text);
            font-size: 14px;
            transition: all 0.2s ease;
        }

        .form-control:hover {
            border-color: var(--border-light);
        }

        .form-control:focus {
            outline: none;
            border-color: var(--accent);
            box-shadow: 0 0 0 3px var(--accent-glow);
            background: var(--bg-secondary);
        }

        .form-control[type="number"] {
            width: 100%;
            font-variant-numeric: tabular-nums;
        }

        select.form-control {
            width: 100%;
            cursor: pointer;
        }

        /* Grid Layout */
        .grid {
            display: grid;
            gap: 20px 28px;
            margin-bottom: 20px;
        }

        .grid:last-child {
            margin-bottom: 0;
        }

        .grid-2 { grid-template-columns: repeat(2, 1fr); }
        .grid-3 { grid-template-columns: repeat(3, 1fr); }
        .grid-4 { grid-template-columns: repeat(4, 1fr); }

        @media (max-width: 768px) {
            .grid-2, .grid-3, .grid-4 { grid-template-columns: 1fr; }
            .panel { padding: 20px; }
            .header { padding: 20px; }
        }

        @media (min-width: 769px) and (max-width: 900px) {
            .grid-3, .grid-4 { grid-template-columns: repeat(2, 1fr); }
        }

        /* Range Slider */
        .range-group {
            display: flex;
            align-items: center;
            gap: 16px;
        }

        .range-input {
            flex: 1;
            height: 6px;
            background: var(--bg-input);
            border-radius: 3px;
            outline: none;
            -webkit-appearance: none;
            border: 1px solid var(--border);
        }

        .range-input::-webkit-slider-thumb {
            -webkit-appearance: none;
            width: 20px;
            height: 20px;
            background: var(--accent);
            border-radius: 50%;
            cursor: pointer;
            box-shadow: 0 2px 6px rgba(233, 69, 96, 0.4);
            transition: transform 0.15s ease;
        }

        .range-input::-webkit-slider-thumb:hover {
            transform: scale(1.1);
        }

        .range-value {
            min-width: 55px;
            text-align: right;
            font-weight: 600;
            color: var(--accent);
            font-size: 14px;
            font-variant-numeric: tabular-nums;
        }

        /* Color Picker */
        .color-group {
            display: flex;
            align-items: center;
            gap: 14px;
        }

        .color-swatch {
            width: 52px;
            height: 42px;
            border-radius: var(--radius-sm);
            border: 2px solid var(--border);
            cursor: pointer;
            transition: all 0.2s ease;
        }

        .color-swatch:hover {
            transform: scale(1.05);
            border-color: var(--border-light);
        }

        .color-rgb {
            font-family: 'SF Mono', 'Fira Code', 'Courier New', monospace;
            font-size: 12px;
            color: var(--text-muted);
            letter-spacing: 0.3px;
        }

        /* Buttons */
        .btn-group {
            display: flex;
            gap: 14px;
            margin-top: 28px;
            padding-top: 28px;
            border-top: 1px solid var(--border);
        }

        .btn {
            flex: 1;
            padding: 13px 28px;
            border: none;
            border-radius: var(--radius-sm);
            font-size: 14px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s ease;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
        }

        .btn-primary {
            background: linear-gradient(135deg, var(--accent) 0%, var(--accent-hover) 100%);
            color: white;
            box-shadow: 0 4px 14px rgba(233, 69, 96, 0.35);
        }

        .btn-primary:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 20px rgba(233, 69, 96, 0.45);
        }

        .btn-secondary {
            background: var(--bg-input);
            color: var(--text);
            border: 1px solid var(--border);
        }

        .btn-secondary:hover {
            background: var(--bg-secondary);
            border-color: var(--border-light);
        }

        /* Alert */
        .alert {
            background: var(--accent-glow);
            border-left: 4px solid var(--accent);
            padding: 14px 18px;
            border-radius: var(--radius-sm);
            margin-bottom: 24px;
            font-size: 13px;
        }

        .alert strong {
            display: block;
            margin-bottom: 6px;
            color: var(--text);
        }

        .alert-warning {
            background: rgba(255, 140, 0, 0.12);
            border-left-color: #ff8c00;
        }

        /* Scrollbar */
        ::-webkit-scrollbar { width: 8px; height: 8px; }
        ::-webkit-scrollbar-track { background: var(--bg-primary); border-radius: 4px; }
        ::-webkit-scrollbar-thumb { background: var(--border); border-radius: 4px; }
        ::-webkit-scrollbar-thumb:hover { background: var(--accent); }
    </style>
</head>
<body>
    <div class="container">
        <!-- Header -->
        <div class="header">
            <h1>CoolerDash Configuration</h1>
            <p>Customize your LCD temperature dashboard â€¢ Changes require plugin restart</p>
            <p style="margin-top: 8px; font-size: 12px; color: var(--text-dim); opacity: 0.8;">
                ðŸ’¡ <strong>Tip:</strong> After an update, click <em>Reset</em> to apply new default values added by the developer.
            </p>
        </div>

        <!-- Tabs -->
        <div class="tabs">
            <button class="tab active" onclick="switchTab(0)">Connection</button>
            <button class="tab" onclick="switchTab(1)">Display</button>
            <button class="tab" onclick="switchTab(2)">Layout</button>
            <button class="tab" onclick="switchTab(3)">Colors</button>
            <button class="tab" onclick="switchTab(4)">CPU</button>
            <button class="tab" onclick="switchTab(5)">GPU</button>
            <button class="tab" onclick="switchTab(6)">Liquid</button>
            <button class="tab" onclick="switchTab(7)">Position</button>
            <button class="tab" onclick="switchTab(8)">Advanced</button>
        </div>

        <form id="configForm">
            <!-- Tab 0: Connection -->
            <div class="panel active">
                <div class="alert">
                    <strong>CoolerControl API</strong>
                    Make sure CoolerControl is running and the API is reachable.
                </div>

                <div class="form-group">
                    <label class="form-label">API Address</label>
                    <span class="form-hint">HTTP or HTTPS supported (Default: http://localhost:11987)</span>
                    <input type="text" name="daemon.address" class="form-control" required>
                </div>
                <br />
                <div class="form-group">
                    <label class="form-label">API Password</label>
                    <span class="form-hint">Leave empty if authentication is disabled (Default: coolAdmin)</span>
                    <input type="password" name="daemon.password" class="form-control">
                </div>
            </div>

            <!-- Tab 1: Display -->
            <div class="panel">
                <h3 class="section-title">Display Mode</h3>

                <div class="grid grid-2">
                    <div class="form-group">
                        <label class="form-label">Display Mode</label>
                        <select name="display.mode" id="display_mode" class="form-control" onchange="toggleCircleInterval()">
                            <option value="dual">Dual (CPU + GPU simultaneously)</option>
                            <option value="circle">Circle (Alternating display)</option>
                        </select>
                    </div>

                    <div class="form-group" id="circle_interval_group" style="display: none;">
                        <label class="form-label">Switch Interval (Seconds)</label>
                        <span class="form-hint">How long each sensor is shown (Default: 5)</span>
                        <input type="number" name="display.circle_switch_interval" class="form-control" min="1" max="60" step="1">
                    </div>
                </div>

                <h3 class="section-title">Sensor Slots</h3>
                <div class="alert">
                    <strong>Sensor Assignment</strong>
                    Assign sensors to display positions. Use "None" to disable a slot.
                </div>

                <div class="grid grid-3">
                    <div class="form-group">
                        <label class="form-label">Upper Slot</label>
                        <span class="form-hint">Default: CPU</span>
                        <select name="display.sensor_slot_up" id="sensor_slot_up" class="form-control" onchange="validateSensorSlots()">
                            <option value="cpu">CPU</option>
                            <option value="gpu">GPU</option>
                            <option value="liquid">Liquid</option>
                            <option value="none">None</option>
                        </select>
                    </div>

                    <div class="form-group" id="sensor_slot_mid_group">
                        <label class="form-label">Middle Slot</label>
                        <span class="form-hint">Default: None (Circle only)</span>
                        <select name="display.sensor_slot_mid" id="sensor_slot_mid" class="form-control" onchange="validateSensorSlots()">
                            <option value="cpu">CPU</option>
                            <option value="gpu">GPU</option>
                            <option value="liquid">Liquid</option>
                            <option value="none">None</option>
                        </select>
                    </div>

                    <div class="form-group">
                        <label class="form-label">Lower Slot</label>
                        <span class="form-hint">Default: GPU</span>
                        <select name="display.sensor_slot_down" id="sensor_slot_down" class="form-control" onchange="validateSensorSlots()">
                            <option value="cpu">CPU</option>
                            <option value="gpu">GPU</option>
                            <option value="liquid">Liquid</option>
                            <option value="none">None</option>
                        </select>
                    </div>
                </div>
                <div id="sensor_slot_warning" class="alert alert-warning" style="display: none;">
                    <strong>Warning</strong>
                    <span id="sensor_slot_warning_text"></span>
                </div>

                <h3 class="section-title">Timing & Brightness</h3>
                <div class="grid grid-2">
                    <div class="form-group">
                        <label class="form-label">Refresh Interval (Seconds)</label>
                        <span class="form-hint">0.2 - 60 seconds (Default: 2.5)</span>
                        <input type="number" name="display.refresh_interval" class="form-control" min="0.2" max="60" step="0.1">
                    </div>

                    <div class="form-group">
                        <label class="form-label">Brightness (%)</label>
                        <span class="form-hint">Default: 80%</span>
                        <div class="range-group">
                            <input type="range" name="display.brightness" id="brightness" class="range-input" min="0" max="100" step="1" oninput="updateRangeValue('brightness', this.value)">
                            <span class="range-value" id="brightness_value">80%</span>
                        </div>
                    </div>
                </div>

                <h3 class="section-title">Display Geometry</h3>
                <div class="grid grid-2">
                    <div class="form-group">
                        <label class="form-label">Orientation</label>
                        <span class="form-hint">Default: 0Â°</span>
                        <select name="display.orientation" class="form-control">
                            <option value="0">0Â° (Default)</option>
                            <option value="90">90Â° (Clockwise)</option>
                            <option value="180">180Â° (Upside Down)</option>
                            <option value="270">270Â° (Counter-Clockwise)</option>
                        </select>
                    </div>

                    <div class="form-group">
                        <label class="form-label">Shape</label>
                        <span class="form-hint">Default: Automatic</span>
                        <select name="display.shape" class="form-control">
                            <option value="auto">Automatic</option>
                            <option value="square">Square</option>
                            <option value="circle">Circle</option>
                        </select>
                    </div>
                </div>

                <div class="grid grid-2">
                    <div class="form-group">
                        <label class="form-label">Width (Pixels)</label>
                        <span class="form-hint">0 = automatic</span>
                        <input type="number" name="display.width" class="form-control" min="0" max="1024">
                    </div>

                    <div class="form-group">
                        <label class="form-label">Height (Pixels)</label>
                        <span class="form-hint">0 = automatic</span>
                        <input type="number" name="display.height" class="form-control" min="0" max="1024">
                    </div>
                </div>

                <div class="grid grid-2">
                    <div class="form-group">
                        <label class="form-label">Content Scale</label>
                        <span class="form-hint">Default: 0.98</span>
                        <input type="number" name="display.content_scale_factor" class="form-control" min="0.5" max="1.0" step="0.01">
                    </div>

                    <div class="form-group">
                        <label class="form-label">Inscribe Factor</label>
                        <span class="form-hint">Default: 0.707</span>
                        <input type="number" name="display.inscribe_factor" class="form-control" min="0.5" max="1.0" step="0.01">
                    </div>
                </div>
            </div>

            <!-- Tab 2: Layout -->
            <div class="panel">
                <h3 class="section-title">Bar Dimensions</h3>
                <div class="grid grid-3">
                    <div class="form-group">
                        <label class="form-label">Default Bar Height</label>
                        <span class="form-hint">Default: 24</span>
                        <input type="number" name="layout.bar_height" class="form-control" min="10" max="100">
                    </div>

                    <div class="form-group">
                        <label class="form-label">Bar Width (%)</label>
                        <span class="form-hint">Default: 98</span>
                        <input type="number" name="layout.bar_width" class="form-control" min="50" max="100">
                    </div>

                    <div class="form-group">
                        <label class="form-label">Bar Gap</label>
                        <span class="form-hint">Default: 12</span>
                        <input type="number" name="layout.bar_gap" class="form-control" min="0" max="50">
                    </div>
                </div>

                <h3 class="section-title">Individual Bar Heights</h3>
                <span class="form-hint" style="margin-bottom: 16px; display: block;">Set to 0 to use default bar height</span>
                <div class="grid grid-3">
                    <div class="form-group">
                        <label class="form-label">Upper Slot Height</label>
                        <span class="form-hint">Default: 0</span>
                        <input type="number" name="layout.bar_height_up" class="form-control" min="0" max="100">
                    </div>

                    <div class="form-group" id="bar_height_mid_group">
                        <label class="form-label">Middle Slot Height</label>
                        <span class="form-hint">Default: 0</span>
                        <input type="number" name="layout.bar_height_mid" class="form-control" min="0" max="100">
                    </div>

                    <div class="form-group">
                        <label class="form-label">Lower Slot Height</label>
                        <span class="form-hint">Default: 0</span>
                        <input type="number" name="layout.bar_height_down" class="form-control" min="0" max="100">
                    </div>
                </div>

                <h3 class="section-title">Border & Margins</h3>
                <div class="grid grid-2">
                    <div class="form-group">
                        <label class="form-label">Show Border</label>
                        <span class="form-hint">Default: On</span>
                        <select name="layout.bar_border_enabled" class="form-control">
                            <option value="1">On</option>
                            <option value="0">Off</option>
                        </select>
                    </div>

                    <div class="form-group">
                        <label class="form-label">Border Thickness</label>
                        <span class="form-hint">Default: 1.0</span>
                        <input type="number" name="layout.bar_border" class="form-control" min="0" max="10" step="0.1">
                    </div>

                    <div class="form-group">
                        <label class="form-label">Label Left Margin</label>
                        <span class="form-hint">Default: 1</span>
                        <input type="number" name="layout.label_margin_left" class="form-control" min="0" max="20">
                    </div>

                    <div class="form-group">
                        <label class="form-label">Label Bar Margin</label>
                        <span class="form-hint">Default: 1</span>
                        <input type="number" name="layout.label_margin_bar" class="form-control" min="0" max="20">
                    </div>
                </div>

                <h3 class="section-title">Font</h3>
                <div class="grid grid-3">
                    <div class="form-group">
                        <label class="form-label">Font Face</label>
                        <span class="form-hint">Default: Roboto Black</span>
                        <input type="text" name="font.face" class="form-control">
                    </div>

                    <div class="form-group">
                        <label class="form-label">Temperature Size</label>
                        <span class="form-hint">Default: 100</span>
                        <input type="number" name="font.size_temp" class="form-control" min="50" max="200">
                    </div>

                    <div class="form-group">
                        <label class="form-label">Label Size</label>
                        <span class="form-hint">Default: 30</span>
                        <input type="number" name="font.size_labels" class="form-control" min="10" max="100">
                    </div>
                </div>
            </div>

            <!-- Tab 3: Colors -->
            <div class="panel">
                <h3 class="section-title">Display Colors</h3>
                <div class="grid grid-2">
                    <div class="form-group">
                        <label class="form-label">Display Background</label>
                        <div class="color-group">
                            <input type="color" id="color_display_background" class="color-swatch" onchange="updateColorRGB('color_display_background', 'rgb_display_background')">
                            <span class="color-rgb" id="rgb_display_background"></span>
                        </div>
                    </div>

                    <div class="form-group">
                        <label class="form-label">Bar Background</label>
                        <div class="color-group">
                            <input type="color" id="color_bar_background" class="color-swatch" onchange="updateColorRGB('color_bar_background', 'rgb_bar_background')">
                            <span class="color-rgb" id="rgb_bar_background"></span>
                        </div>
                    </div>

                    <div class="form-group">
                        <label class="form-label">Bar Border</label>
                        <div class="color-group">
                            <input type="color" id="color_bar_border" class="color-swatch" onchange="updateColorRGB('color_bar_border', 'rgb_bar_border')">
                            <span class="color-rgb" id="rgb_bar_border"></span>
                        </div>
                    </div>
                </div>

                <h3 class="section-title">Text Colors</h3>
                <div class="grid grid-2">
                    <div class="form-group">
                        <label class="form-label">Temperature Text</label>
                        <div class="color-group">
                            <input type="color" id="color_font_temp" class="color-swatch" onchange="updateColorRGB('color_font_temp', 'rgb_font_temp')">
                            <span class="color-rgb" id="rgb_font_temp"></span>
                        </div>
                    </div>

                    <div class="form-group">
                        <label class="form-label">Label Text</label>
                        <div class="color-group">
                            <input type="color" id="color_font_label" class="color-swatch" onchange="updateColorRGB('color_font_label', 'rgb_font_label')">
                            <span class="color-rgb" id="rgb_font_label"></span>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Tab 4: CPU Thresholds -->
            <div class="panel">
                <h3 class="section-title">CPU Thresholds</h3>
                <div class="grid grid-4">
                    <div class="form-group">
                        <label class="form-label">Threshold 1 (Â°C)</label>
                        <span class="form-hint">Default: 55</span>
                        <input type="number" name="cpu.threshold_1" class="form-control" min="0" max="100">
                    </div>

                    <div class="form-group">
                        <label class="form-label">Threshold 2 (Â°C)</label>
                        <span class="form-hint">Default: 65</span>
                        <input type="number" name="cpu.threshold_2" class="form-control" min="0" max="100">
                    </div>

                    <div class="form-group">
                        <label class="form-label">Threshold 3 (Â°C)</label>
                        <span class="form-hint">Default: 75</span>
                        <input type="number" name="cpu.threshold_3" class="form-control" min="0" max="100">
                    </div>

                    <div class="form-group">
                        <label class="form-label">Max Scale (Â°C)</label>
                        <span class="form-hint">Default: 115</span>
                        <input type="number" name="cpu.max_scale" class="form-control" min="80" max="150">
                    </div>
                </div>

                <h3 class="section-title">CPU Bar Colors</h3>
                <div class="grid grid-4">
                    <div class="form-group">
                        <label class="form-label">Color 1 (< Threshold 1)</label>
                        <div class="color-group">
                            <input type="color" id="color_cpu_1" class="color-swatch" onchange="updateColorRGB('color_cpu_1', 'rgb_cpu_1')">
                            <span class="color-rgb" id="rgb_cpu_1"></span>
                        </div>
                    </div>

                    <div class="form-group">
                        <label class="form-label">Color 2 (Threshold 1-2)</label>
                        <div class="color-group">
                            <input type="color" id="color_cpu_2" class="color-swatch" onchange="updateColorRGB('color_cpu_2', 'rgb_cpu_2')">
                            <span class="color-rgb" id="rgb_cpu_2"></span>
                        </div>
                    </div>

                    <div class="form-group">
                        <label class="form-label">Color 3 (Threshold 2-3)</label>
                        <div class="color-group">
                            <input type="color" id="color_cpu_3" class="color-swatch" onchange="updateColorRGB('color_cpu_3', 'rgb_cpu_3')">
                            <span class="color-rgb" id="rgb_cpu_3"></span>
                        </div>
                    </div>

                    <div class="form-group">
                        <label class="form-label">Color 4 (> Threshold 3)</label>
                        <div class="color-group">
                            <input type="color" id="color_cpu_4" class="color-swatch" onchange="updateColorRGB('color_cpu_4', 'rgb_cpu_4')">
                            <span class="color-rgb" id="rgb_cpu_4"></span>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Tab 5: GPU Thresholds -->
            <div class="panel">
                <h3 class="section-title">GPU Thresholds</h3>
                <div class="grid grid-4">
                    <div class="form-group">
                        <label class="form-label">Threshold 1 (Â°C)</label>
                        <span class="form-hint">Default: 55</span>
                        <input type="number" name="gpu.threshold_1" class="form-control" min="0" max="100">
                    </div>

                    <div class="form-group">
                        <label class="form-label">Threshold 2 (Â°C)</label>
                        <span class="form-hint">Default: 65</span>
                        <input type="number" name="gpu.threshold_2" class="form-control" min="0" max="100">
                    </div>

                    <div class="form-group">
                        <label class="form-label">Threshold 3 (Â°C)</label>
                        <span class="form-hint">Default: 75</span>
                        <input type="number" name="gpu.threshold_3" class="form-control" min="0" max="100">
                    </div>

                    <div class="form-group">
                        <label class="form-label">Max Scale (Â°C)</label>
                        <span class="form-hint">Default: 115</span>
                        <input type="number" name="gpu.max_scale" class="form-control" min="80" max="150">
                    </div>
                </div>

                <h3 class="section-title">GPU Bar Colors</h3>
                <div class="grid grid-4">
                    <div class="form-group">
                        <label class="form-label">Color 1 (< Threshold 1)</label>
                        <div class="color-group">
                            <input type="color" id="color_gpu_1" class="color-swatch" onchange="updateColorRGB('color_gpu_1', 'rgb_gpu_1')">
                            <span class="color-rgb" id="rgb_gpu_1"></span>
                        </div>
                    </div>

                    <div class="form-group">
                        <label class="form-label">Color 2 (Threshold 1-2)</label>
                        <div class="color-group">
                            <input type="color" id="color_gpu_2" class="color-swatch" onchange="updateColorRGB('color_gpu_2', 'rgb_gpu_2')">
                            <span class="color-rgb" id="rgb_gpu_2"></span>
                        </div>
                    </div>

                    <div class="form-group">
                        <label class="form-label">Color 3 (Threshold 2-3)</label>
                        <div class="color-group">
                            <input type="color" id="color_gpu_3" class="color-swatch" onchange="updateColorRGB('color_gpu_3', 'rgb_gpu_3')">
                            <span class="color-rgb" id="rgb_gpu_3"></span>
                        </div>
                    </div>

                    <div class="form-group">
                        <label class="form-label">Color 4 (> Threshold 3)</label>
                        <div class="color-group">
                            <input type="color" id="color_gpu_4" class="color-swatch" onchange="updateColorRGB('color_gpu_4', 'rgb_gpu_4')">
                            <span class="color-rgb" id="rgb_gpu_4"></span>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Tab 6: Liquid Thresholds -->
            <div class="panel">
                <h3 class="section-title">Liquid Thresholds</h3>
                <div class="grid grid-4">
                    <div class="form-group">
                        <label class="form-label">Threshold 1 (Â°C)</label>
                        <span class="form-hint">Default: 25</span>
                        <input type="number" name="liquid.threshold_1" class="form-control" min="0" max="50">
                    </div>

                    <div class="form-group">
                        <label class="form-label">Threshold 2 (Â°C)</label>
                        <span class="form-hint">Default: 28</span>
                        <input type="number" name="liquid.threshold_2" class="form-control" min="0" max="50">
                    </div>

                    <div class="form-group">
                        <label class="form-label">Threshold 3 (Â°C)</label>
                        <span class="form-hint">Default: 31</span>
                        <input type="number" name="liquid.threshold_3" class="form-control" min="0" max="50">
                    </div>

                    <div class="form-group">
                        <label class="form-label">Max Scale (Â°C)</label>
                        <span class="form-hint">Default: 50</span>
                        <input type="number" name="liquid.max_scale" class="form-control" min="30" max="80">
                    </div>
                </div>

                <h3 class="section-title">Liquid Bar Colors</h3>
                <div class="grid grid-4">
                    <div class="form-group">
                        <label class="form-label">Color 1 (< Threshold 1)</label>
                        <div class="color-group">
                            <input type="color" id="color_liquid_1" class="color-swatch" onchange="updateColorRGB('color_liquid_1', 'rgb_liquid_1')">
                            <span class="color-rgb" id="rgb_liquid_1"></span>
                        </div>
                    </div>

                    <div class="form-group">
                        <label class="form-label">Color 2 (Threshold 1-2)</label>
                        <div class="color-group">
                            <input type="color" id="color_liquid_2" class="color-swatch" onchange="updateColorRGB('color_liquid_2', 'rgb_liquid_2')">
                            <span class="color-rgb" id="rgb_liquid_2"></span>
                        </div>
                    </div>

                    <div class="form-group">
                        <label class="form-label">Color 3 (Threshold 2-3)</label>
                        <div class="color-group">
                            <input type="color" id="color_liquid_3" class="color-swatch" onchange="updateColorRGB('color_liquid_3', 'rgb_liquid_3')">
                            <span class="color-rgb" id="rgb_liquid_3"></span>
                        </div>
                    </div>

                    <div class="form-group">
                        <label class="form-label">Color 4 (> Threshold 3)</label>
                        <div class="color-group">
                            <input type="color" id="color_liquid_4" class="color-swatch" onchange="updateColorRGB('color_liquid_4', 'rgb_liquid_4')">
                            <span class="color-rgb" id="rgb_liquid_4"></span>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Tab 7: Positioning -->
            <div class="panel">
                <div class="alert">
                    <strong>Advanced Positioning</strong>
                    Value 0 = Automatic positioning. Adjust offsets to fine-tune element placement.
                </div>

                <h3 class="section-title">Upper Slot Position</h3>
                <div class="grid grid-2">
                    <div class="form-group">
                        <label class="form-label">X Offset</label>
                        <span class="form-hint">Default: 0</span>
                        <input type="number" name="positioning.temp_offset_x_cpu" class="form-control" step="1">
                    </div>

                    <div class="form-group">
                        <label class="form-label">Y Offset</label>
                        <span class="form-hint">Default: 0</span>
                        <input type="number" name="positioning.temp_offset_y_cpu" class="form-control" step="1">
                    </div>
                </div>

                <h3 class="section-title">Middle Slot Position</h3>
                <div class="grid grid-2">
                    <div class="form-group">
                        <label class="form-label">X Offset</label>
                        <span class="form-hint">Default: 0</span>
                        <input type="number" name="positioning.temp_offset_x_liquid" class="form-control" step="1">
                    </div>

                    <div class="form-group">
                        <label class="form-label">Y Offset</label>
                        <span class="form-hint">Default: 0</span>
                        <input type="number" name="positioning.temp_offset_y_liquid" class="form-control" step="1">
                    </div>
                </div>

                <h3 class="section-title">Lower Slot Position</h3>
                <div class="grid grid-2">
                    <div class="form-group">
                        <label class="form-label">X Offset</label>
                        <span class="form-hint">Default: 0</span>
                        <input type="number" name="positioning.temp_offset_x_gpu" class="form-control" step="1">
                    </div>

                    <div class="form-group">
                        <label class="form-label">Y Offset</label>
                        <span class="form-hint">Default: 0</span>
                        <input type="number" name="positioning.temp_offset_y_gpu" class="form-control" step="1">
                    </div>
                </div>

                <h3 class="section-title">Labels Position</h3>
                <div class="grid grid-3">
                    <div class="form-group">
                        <label class="form-label">X Offset</label>
                        <span class="form-hint">Default: 0</span>
                        <input type="number" name="positioning.label_offset_x" class="form-control" step="1">
                    </div>

                    <div class="form-group">
                        <label class="form-label">Y Offset</label>
                        <span class="form-hint">Default: 0</span>
                        <input type="number" name="positioning.label_offset_y" class="form-control" step="1">
                    </div>

                    <div class="form-group">
                        <label class="form-label">Degree Symbol Spacing</label>
                        <span class="form-hint">Default: 16</span>
                        <input type="number" name="positioning.degree_spacing" class="form-control" min="0" max="50">
                    </div>
                </div>
            </div>

            <!-- Tab 8: Advanced -->
            <div class="panel">
                <h3 class="section-title">Image Paths</h3>

                <div class="form-group">
                    <label class="form-label">Shutdown Image</label>
                    <span class="form-hint">Image displayed when daemon stops (Default: /etc/coolercontrol/plugins/coolerdash/shutdown.png)</span>
                    <input type="text" name="paths.image_shutdown" class="form-control">
                </div>

                <h3 class="section-title">Backup & Restore</h3>
                <div class="alert">
                    <strong>Configuration Backup</strong>
                    Export your current settings as a JSON file for backup or migration.
                </div>
                <button type="button" class="btn btn-secondary" onclick="exportConfig()" style="width: auto; padding: 10px 20px;">
                    ðŸ’¾ Export Configuration
                </button>
            </div>
        </form>

        <!-- Buttons -->
        <div class="btn-group">
            <button type="button" class="btn btn-primary" onclick="saveConfig()">Save</button>
            <button type="button" class="btn btn-secondary" onclick="resetConfig()">Reset</button>
        </div>

        <!-- Restart Notice -->
        <div style="margin-top: 16px; padding: 12px; background: rgba(255, 140, 0, 0.05); border-left: 3px solid #ff8c00; border-radius: 4px;">
            <p style="margin: 0; color: var(--text-dim); font-size: 13px;">
                <strong>Note:</strong> Changes are applied immediately â€” the plugin will be restarted automatically after Save or Reset.
            </p>
        </div>
    </div>

    <script>
        // ===== FACTORY DEFAULT CONFIGURATION =====
        const FACTORY_DEFAULTS = {
            daemon: {
                address: "http://localhost:11987",
                password: "coolAdmin"
            },
            paths: {
                image_shutdown: "/etc/coolercontrol/plugins/coolerdash/shutdown.png"
            },
            display: {
                mode: "dual",
                circle_switch_interval: 5,
                refresh_interval: 2.5,
                brightness: 80,
                orientation: 0,
                width: 0,
                height: 0,
                shape: "auto",
                content_scale_factor: 0.98,
                inscribe_factor: 0.70710678,
                sensor_slot_up: "cpu",
                sensor_slot_mid: "liquid",
                sensor_slot_down: "gpu"
            },
            layout: {
                bar_height: 24,
                bar_width: 98,
                bar_gap: 12,
                bar_border: 1.0,
                bar_border_enabled: 1,
                label_margin_left: 1,
                label_margin_bar: 1,
                bar_height_up: 0,
                bar_height_mid: 0,
                bar_height_down: 0
            },
            colors: {
                display_background: { r: 0, g: 0, b: 0 },
                bar_background: { r: 52, g: 52, b: 52 },
                bar_border: { r: 192, g: 192, b: 192 },
                font_temp: { r: 255, g: 255, b: 255 },
                font_label: { r: 200, g: 200, b: 200 }
            },
            font: {
                face: "Roboto Black",
                size_temp: 100.0,
                size_labels: 30.0
            },
            cpu: {
                threshold_1: 55.0,
                threshold_2: 65.0,
                threshold_3: 75.0,
                max_scale: 115.0,
                threshold_1_color: { r: 0, g: 255, b: 0 },
                threshold_2_color: { r: 255, g: 140, b: 0 },
                threshold_3_color: { r: 255, g: 70, b: 0 },
                threshold_4_color: { r: 255, g: 0, b: 0 }
            },
            gpu: {
                threshold_1: 55.0,
                threshold_2: 65.0,
                threshold_3: 75.0,
                max_scale: 115.0,
                threshold_1_color: { r: 0, g: 255, b: 0 },
                threshold_2_color: { r: 255, g: 140, b: 0 },
                threshold_3_color: { r: 255, g: 70, b: 0 },
                threshold_4_color: { r: 255, g: 0, b: 0 }
            },
            liquid: {
                max_scale: 50.0,
                threshold_1: 25.0,
                threshold_2: 28.0,
                threshold_3: 31.0,
                threshold_1_color: { r: 0, g: 255, b: 0 },
                threshold_2_color: { r: 255, g: 140, b: 0 },
                threshold_3_color: { r: 255, g: 70, b: 0 },
                threshold_4_color: { r: 255, g: 0, b: 0 }
            },
            positioning: {
                temp_offset_x_cpu: 0,
                temp_offset_x_gpu: 0,
                temp_offset_y_cpu: 0,
                temp_offset_y_gpu: 0,
                temp_offset_x_liquid: 0,
                temp_offset_y_liquid: 0,
                degree_spacing: 16,
                label_offset_x: 0,
                label_offset_y: 0
            }
        };

        let DEFAULT_CONFIG = null;
        let currentTab = 0;

        // ===== FALLBACK FUNCTIONS =====
        const isInCoolerControl = window.parent !== window;

        if (typeof savePluginConfig === 'undefined') {
            window.savePluginConfig = async function(config) {
                if (isInCoolerControl) {
                    return new Promise((resolve, reject) => {
                        const messageHandler = (event) => {
                            if (event.data.type === 'configSaved') {
                                window.removeEventListener('message', messageHandler);
                                if (event.data.body) resolve(event.data.body);
                                else reject(new Error('Config save failed'));
                            }
                        };
                        window.addEventListener('message', messageHandler);
                        window.parent.postMessage({ type: 'saveConfig', body: config }, document.location.origin);
                        setTimeout(() => {
                            window.removeEventListener('message', messageHandler);
                            reject(new Error('Save timeout'));
                        }, 5000);
                    });
                } else {
                    localStorage.setItem('coolerdash_config', JSON.stringify(config));
                    return Promise.resolve(config);
                }
            };
        }

        if (typeof getPluginConfig === 'undefined') {
            window.getPluginConfig = async function() {
                if (isInCoolerControl) {
                    return new Promise((resolve) => {
                        const messageHandler = (event) => {
                            if (event.data.type === 'config') {
                                window.removeEventListener('message', messageHandler);
                                resolve(event.data.body || {});
                            }
                        };
                        window.addEventListener('message', messageHandler);
                        window.parent.postMessage({ type: 'loadConfig' }, document.location.origin);
                        setTimeout(() => {
                            window.removeEventListener('message', messageHandler);
                            resolve({});
                        }, 3000);
                    });
                } else {
                    const saved = localStorage.getItem('coolerdash_config');
                    return Promise.resolve(saved ? JSON.parse(saved) : {});
                }
            };
        }

        if (typeof runPluginScript === 'undefined') {
            window.runPluginScript = function(mainFunction) { mainFunction(); };
        }

        // ===== UI FUNCTIONS =====
        function switchTab(index) {
            document.querySelectorAll('.tab').forEach((tab, i) => tab.classList.toggle('active', i === index));
            document.querySelectorAll('.panel').forEach((panel, i) => panel.classList.toggle('active', i === index));
            currentTab = index;
        }

        function toggleCircleInterval() {
            const mode = document.getElementById('display_mode').value;
            document.getElementById('circle_interval_group').style.display = mode === 'circle' ? 'block' : 'none';
            const midSlotGroup = document.getElementById('sensor_slot_mid_group');
            const midBarHeightGroup = document.getElementById('bar_height_mid_group');
            if (midSlotGroup) midSlotGroup.style.display = mode === 'circle' ? 'block' : 'none';
            if (midBarHeightGroup) midBarHeightGroup.style.display = mode === 'circle' ? 'block' : 'none';
            if (mode === 'dual') {
                const midSlot = document.getElementById('sensor_slot_mid');
                if (midSlot) midSlot.value = 'none';
            }
            validateSensorSlots();
        }

        function validateSensorSlots() {
            const mode = document.getElementById('display_mode').value;
            const slotUp = document.getElementById('sensor_slot_up').value;
            const slotMid = document.getElementById('sensor_slot_mid').value;
            const slotDown = document.getElementById('sensor_slot_down').value;

            const warningDiv = document.getElementById('sensor_slot_warning');
            const warningText = document.getElementById('sensor_slot_warning_text');
            let warnings = [];

            const activeSlots = [];
            if (slotUp !== 'none') activeSlots.push({ name: 'Upper', value: slotUp });
            if (mode === 'circle' && slotMid !== 'none') activeSlots.push({ name: 'Middle', value: slotMid });
            if (slotDown !== 'none') activeSlots.push({ name: 'Lower', value: slotDown });

            if (activeSlots.length === 0) warnings.push('At least one sensor slot must be active.');

            const usedSensors = {};
            for (const slot of activeSlots) {
                if (usedSensors[slot.value]) {
                    warnings.push(`Duplicate: "${slot.value}" used in ${usedSensors[slot.value]} and ${slot.name}.`);
                } else {
                    usedSensors[slot.value] = slot.name;
                }
            }

            warningDiv.style.display = warnings.length > 0 ? 'block' : 'none';
            warningText.textContent = warnings.join(' ');
            return warnings.length === 0;
        }

        function updateRangeValue(id, value) {
            document.getElementById(id + '_value').textContent = value + '%';
        }

        function rgbToHex(rgb) {
            const r = Math.round(rgb.r).toString(16).padStart(2, '0');
            const g = Math.round(rgb.g).toString(16).padStart(2, '0');
            const b = Math.round(rgb.b).toString(16).padStart(2, '0');
            return `#${r}${g}${b}`;
        }

        function hexToRgb(hex) {
            const result = /^#?([a-f\d]{2})([a-f\d]{2})([a-f\d]{2})$/i.exec(hex);
            return result ? { r: parseInt(result[1], 16), g: parseInt(result[2], 16), b: parseInt(result[3], 16) } : null;
        }

        function updateColorRGB(colorId, rgbId) {
            const rgb = hexToRgb(document.getElementById(colorId).value);
            if (rgb) document.getElementById(rgbId).textContent = `RGB(${rgb.r}, ${rgb.g}, ${rgb.b})`;
        }

        function setupColorPicker(colorId, rgbId, rgbObj) {
            const colorInput = document.getElementById(colorId);
            if (rgbObj && colorInput) {
                colorInput.value = rgbToHex(rgbObj);
                const rgbEl = document.getElementById(rgbId);
                if (rgbEl) rgbEl.textContent = `RGB(${Math.round(rgbObj.r)}, ${Math.round(rgbObj.g)}, ${Math.round(rgbObj.b)})`;
            }
        }

        function getColorFromPicker(colorId) {
            const el = document.getElementById(colorId);
            return el ? hexToRgb(el.value) : null;
        }

        async function loadDefaultConfig() {
            try {
                const response = await fetch('config.json');
                if (!response.ok) throw new Error(`HTTP ${response.status}`);
                DEFAULT_CONFIG = await response.json();
                return DEFAULT_CONFIG;
            } catch (error) {
                console.error("Failed to load config.json:", error);
                DEFAULT_CONFIG = FACTORY_DEFAULTS;
                return DEFAULT_CONFIG;
            }
        }

        function buildConfig() {
            const form = document.getElementById('configForm');
            const formData = new FormData(form);
            const config = {
                daemon: {}, paths: {}, display: {}, layout: {}, colors: {},
                font: {}, cpu: {}, gpu: {}, liquid: {}, positioning: {}
            };

            for (const [key, value] of formData.entries()) {
                const [section, field] = key.split('.');
                if (section && field && config[section]) {
                    const numValue = parseFloat(value);
                    config[section][field] = isNaN(numValue) ? value : numValue;
                }
            }

            // Colors
            config.colors.display_background = getColorFromPicker('color_display_background');
            config.colors.bar_background = getColorFromPicker('color_bar_background');
            config.colors.bar_border = getColorFromPicker('color_bar_border');
            config.colors.font_temp = getColorFromPicker('color_font_temp');
            config.colors.font_label = getColorFromPicker('color_font_label');

            // CPU colors
            config.cpu.threshold_1_color = getColorFromPicker('color_cpu_1');
            config.cpu.threshold_2_color = getColorFromPicker('color_cpu_2');
            config.cpu.threshold_3_color = getColorFromPicker('color_cpu_3');
            config.cpu.threshold_4_color = getColorFromPicker('color_cpu_4');

            // GPU colors
            config.gpu.threshold_1_color = getColorFromPicker('color_gpu_1');
            config.gpu.threshold_2_color = getColorFromPicker('color_gpu_2');
            config.gpu.threshold_3_color = getColorFromPicker('color_gpu_3');
            config.gpu.threshold_4_color = getColorFromPicker('color_gpu_4');

            // Liquid colors
            config.liquid.threshold_1_color = getColorFromPicker('color_liquid_1');
            config.liquid.threshold_2_color = getColorFromPicker('color_liquid_2');
            config.liquid.threshold_3_color = getColorFromPicker('color_liquid_3');
            config.liquid.threshold_4_color = getColorFromPicker('color_liquid_4');

            return config;
        }

        function populateForm(config) {
            for (const [section, fields] of Object.entries(config)) {
                if (typeof fields === 'object' && fields !== null) {
                    for (const [field, value] of Object.entries(fields)) {
                        const input = document.querySelector(`[name="${section}.${field}"]`);
                        if (input && typeof value !== 'object') {
                            input.value = typeof value === 'boolean' ? (value ? "1" : "0") : value;
                            if (field === 'brightness') updateRangeValue('brightness', value);
                        }
                    }
                }
            }

            // Colors
            if (config.colors) {
                setupColorPicker('color_display_background', 'rgb_display_background', config.colors.display_background);
                setupColorPicker('color_bar_background', 'rgb_bar_background', config.colors.bar_background);
                setupColorPicker('color_bar_border', 'rgb_bar_border', config.colors.bar_border);
                setupColorPicker('color_font_temp', 'rgb_font_temp', config.colors.font_temp);
                setupColorPicker('color_font_label', 'rgb_font_label', config.colors.font_label);
            }

            // CPU colors
            if (config.cpu) {
                setupColorPicker('color_cpu_1', 'rgb_cpu_1', config.cpu.threshold_1_color);
                setupColorPicker('color_cpu_2', 'rgb_cpu_2', config.cpu.threshold_2_color);
                setupColorPicker('color_cpu_3', 'rgb_cpu_3', config.cpu.threshold_3_color);
                setupColorPicker('color_cpu_4', 'rgb_cpu_4', config.cpu.threshold_4_color);
            }

            // GPU colors
            if (config.gpu) {
                setupColorPicker('color_gpu_1', 'rgb_gpu_1', config.gpu.threshold_1_color);
                setupColorPicker('color_gpu_2', 'rgb_gpu_2', config.gpu.threshold_2_color);
                setupColorPicker('color_gpu_3', 'rgb_gpu_3', config.gpu.threshold_3_color);
                setupColorPicker('color_gpu_4', 'rgb_gpu_4', config.gpu.threshold_4_color);
            }

            // Liquid colors
            if (config.liquid) {
                setupColorPicker('color_liquid_1', 'rgb_liquid_1', config.liquid.threshold_1_color);
                setupColorPicker('color_liquid_2', 'rgb_liquid_2', config.liquid.threshold_2_color);
                setupColorPicker('color_liquid_3', 'rgb_liquid_3', config.liquid.threshold_3_color);
                setupColorPicker('color_liquid_4', 'rgb_liquid_4', config.liquid.threshold_4_color);
            }

            toggleCircleInterval();
            validateSensorSlots();
        }

        async function saveConfig() {
            if (!validateSensorSlots()) {
                alert("Please fix sensor slot warnings before saving.");
                return;
            }

            const config = buildConfig();
            try {
                await writeConfigToFile(config);
                requestRestartAfterSave(1000);
                await savePluginConfig(config);
                alert("Configuration saved! Plugin will restart.");
                setTimeout(() => window.close(), 300);
            } catch (error) {
                console.error("Save failed:", error);
                alert("Save failed: " + error.message);
            }
        }

        function exportConfig() {
            try {
                const config = buildConfig();
                const jsonStr = JSON.stringify(config, null, 2);
                const blob = new Blob([jsonStr], { type: 'application/json' });
                const url = URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.href = url;
                const date = new Date().toISOString().slice(0, 10);
                a.download = `coolerdash-config-backup-${date}.json`;
                document.body.appendChild(a);
                a.click();
                document.body.removeChild(a);
                URL.revokeObjectURL(url);
            } catch (error) {
                console.error("Export failed:", error);
                alert("Export failed: " + error.message);
            }
        }

        async function restartPluginDaemon(config) {
            try {
                const apiAddress = config.daemon?.address || 'http://localhost:11987';
                const password = config.daemon?.password || '';
                const headers = { 'Content-Type': 'application/json' };
                if (password) headers['Authorization'] = `Basic ${btoa(`admin:${password}`)}`;

                const response = await fetch(`${apiAddress}/plugins/coolerdash/restart`, { method: 'POST', headers });
                if (!response.ok) console.warn("Could not restart plugin automatically");
            } catch (error) {
                console.error("Plugin restart failed:", error);
            }
        }

        function requestRestartAfterSave(delayMs = 800) {
            const doRestart = () => {
                try {
                    if (typeof restart === 'function') restart();
                    else restartPluginDaemon(buildConfig());
                } catch (e) { console.warn('Restart failed:', e); }
            };

            if (typeof successfulConfigSaveCallback === 'function') {
                successfulConfigSaveCallback(() => setTimeout(doRestart, delayMs));
            } else {
                const handler = (event) => {
                    if (event.data?.type === 'configSaved') {
                        window.removeEventListener('message', handler);
                        setTimeout(doRestart, delayMs);
                    }
                };
                window.addEventListener('message', handler);
            }
        }

        async function writeConfigToFile(config) {
            try {
                const apiAddress = config.daemon?.address || 'http://localhost:11987';
                const password = config.daemon?.password || '';

                if (password) {
                    const response = await fetch(`${apiAddress}/plugins/coolerdash/config`, {
                        method: 'PUT',
                        headers: { 'Content-Type': 'application/json', 'Authorization': `Basic ${btoa(`admin:${password}`)}` },
                        body: JSON.stringify(config, null, 2)
                    });
                    if (response.ok) return true;
                }

                const blob = new Blob([JSON.stringify(config, null, 2)], { type: 'application/json' });
                const a = document.createElement('a');
                a.href = URL.createObjectURL(blob);
                a.download = 'config.json';
                a.click();
                URL.revokeObjectURL(a.href);
                return false;
            } catch (error) {
                console.warn("Config write failed:", error);
                return false;
            }
        }

        async function resetConfig() {
            try {
                await writeConfigToFile(FACTORY_DEFAULTS);
                populateForm(FACTORY_DEFAULTS);
                requestRestartAfterSave(1000);
                await savePluginConfig(FACTORY_DEFAULTS);
                alert('Reset to factory defaults! Plugin will restart.');
                setTimeout(() => window.close(), 300);
            } catch (error) {
                console.error("Reset failed:", error);
                alert('Reset failed: ' + error.message);
            }
        }

        // Initialize
        runPluginScript(async () => {
            try {
                await loadDefaultConfig();
                let config = await getPluginConfig();

                if (!config || Object.keys(config).length === 0) {
                    config = DEFAULT_CONFIG;
                } else {
                    config = {
                        daemon: { ...DEFAULT_CONFIG.daemon, ...(config.daemon || {}) },
                        paths: { ...DEFAULT_CONFIG.paths, ...(config.paths || {}) },
                        display: { ...DEFAULT_CONFIG.display, ...(config.display || {}) },
                        layout: { ...DEFAULT_CONFIG.layout, ...(config.layout || {}) },
                        colors: { ...DEFAULT_CONFIG.colors, ...(config.colors || {}) },
                        font: { ...DEFAULT_CONFIG.font, ...(config.font || {}) },
                        cpu: { ...DEFAULT_CONFIG.cpu, ...(config.cpu || {}) },
                        gpu: { ...DEFAULT_CONFIG.gpu, ...(config.gpu || {}) },
                        liquid: { ...DEFAULT_CONFIG.liquid, ...(config.liquid || {}) },
                        positioning: { ...DEFAULT_CONFIG.positioning, ...(config.positioning || {}) }
                    };
                }

                populateForm(config);
            } catch (error) {
                console.error("Init failed:", error);
                if (DEFAULT_CONFIG) populateForm(DEFAULT_CONFIG);
            }
        });
    </script>
</body>
</html>
