<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>CoolerDash Settings</title>
    <script type="text/javascript" src="cc-plugin-lib.js" onerror="console.warn('cc-plugin-lib.js not found, using fallback')"></script>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }

        :root {
            --bg-primary: rgb(26, 26, 46);
            --bg-secondary: rgb(22, 33, 62);
            --bg-card: rgb(30, 35, 55);
            --bg-input: rgb(20, 28, 48);
            --border: rgb(45, 66, 99);
            --border-light: rgb(55, 76, 109);
            --text: rgb(234, 234, 234);
            --text-dim: rgb(140, 145, 165);
            --text-muted: rgb(100, 105, 125);
            --accent: rgb(233, 69, 96);
            --accent-hover: rgb(255, 89, 116);
            --accent-glow: rgba(233, 69, 96, 0.15);
            --success: rgb(34, 197, 94);
            --radius: 10px;
            --radius-sm: 6px;
            --shadow: 0 4px 20px rgba(0, 0, 0, 0.25);
            --shadow-sm: 0 2px 8px rgba(0, 0, 0, 0.2);
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, 'Inter', sans-serif;
            background: linear-gradient(135deg, var(--bg-secondary) 0%, var(--bg-primary) 100%);
            color: var(--text);
            line-height: 1.6;
            padding: 24px;
            min-height: 100vh;
        }

        .container {
            max-width: 920px;
            margin: 0 auto;
        }

        /* Header */
        .header {
            background: var(--bg-card);
            border-radius: var(--radius);
            padding: 28px 32px;
            margin-bottom: 20px;
            box-shadow: var(--shadow);
            border: 1px solid var(--border);
        }

        .header h1 {
            font-size: 26px;
            font-weight: 700;
            margin-bottom: 10px;
            display: flex;
            align-items: center;
            gap: 12px;
            background: linear-gradient(135deg, var(--text) 0%, var(--text-dim) 100%);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
        }

        .header p {
            color: var(--text-dim);
            font-size: 14px;
        }

        /* Device Tab */
        .device-info-card {
            background: var(--bg-input);
            border: 1px solid var(--border);
            border-radius: var(--radius);
            padding: 20px 24px;
            margin-bottom: 16px;
        }

        .device-info-row {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 10px 0;
            border-bottom: 1px solid rgba(45, 66, 99, 0.4);
        }

        .device-info-row:last-child {
            border-bottom: none;
        }

        .device-info-label {
            font-size: 13px;
            color: var(--text-dim);
            font-weight: 500;
        }

        .device-info-value {
            font-size: 14px;
            font-weight: 600;
            color: var(--text);
        }

        .device-info-value.mono {
            font-family: 'SF Mono', 'Fira Code', 'Courier New', monospace;
        }

        .device-status {
            display: inline-flex;
            align-items: center;
            gap: 6px;
            padding: 3px 10px;
            border-radius: 12px;
            font-size: 12px;
            font-weight: 600;
        }

        .device-status.connected {
            background: rgba(34, 197, 94, 0.12);
            color: var(--success);
        }

        .device-status.disconnected {
            background: rgba(255, 140, 0, 0.12);
            color: #ff8c00;
        }

        .device-status.error {
            background: rgba(233, 69, 96, 0.12);
            color: var(--accent);
        }

        .device-status-dot {
            width: 7px;
            height: 7px;
            border-radius: 50%;
            background: currentColor;
        }

        .info-item {
            margin-bottom: 20px;
        }

        .info-item-label {
            font-size: 11px;
            color: var(--text-muted);
            text-transform: uppercase;
            letter-spacing: 0.8px;
            margin-bottom: 4px;
        }

        .info-item-value {
            font-size: 14px;
            color: var(--text);
        }

        .info-item-value a {
            color: var(--accent);
            text-decoration: none;
        }

        .info-item-value a:hover {
            color: var(--accent-hover);
            text-decoration: underline;
        }

        /* Tabs */
        .tabs {
            display: flex;
            gap: 6px;
            margin-bottom: 20px;
            background: var(--bg-card);
            padding: 10px;
            border-radius: var(--radius);
            box-shadow: var(--shadow-sm);
            overflow-x: auto;
            flex-wrap: wrap;
            border: 1px solid var(--border);
        }

        .tab {
            flex: 1;
            min-width: 85px;
            padding: 11px 14px;
            background: transparent;
            border: none;
            border-radius: var(--radius-sm);
            color: var(--text-dim);
            cursor: pointer;
            font-size: 13px;
            font-weight: 500;
            transition: all 0.2s ease;
            white-space: nowrap;
        }

        .tab:hover {
            background: var(--accent-glow);
            color: var(--text);
        }

        .tab.active {
            background: var(--accent);
            color: white;
            box-shadow: 0 2px 8px rgba(233, 69, 96, 0.4);
        }

        /* Panel */
        .panel {
            display: none;
            background: var(--bg-card);
            border-radius: var(--radius);
            padding: 28px 32px;
            box-shadow: var(--shadow);
            animation: fadeIn 0.3s ease;
            border: 1px solid var(--border);
        }

        .panel.active {
            display: block;
        }

        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(8px); }
            to { opacity: 1; transform: translateY(0); }
        }

        /* Section Title */
        .section-title {
            margin: 32px 0 20px;
            font-size: 13px;
            font-weight: 600;
            color: var(--accent);
            border-bottom: 1px solid var(--border);
            padding-bottom: 10px;
            text-transform: uppercase;
            letter-spacing: 1px;
        }

        .section-title:first-child {
            margin-top: 0;
        }

        /* Form Elements */
        .form-group {
            margin-bottom: 0;
        }

        /* Spacing between form-groups outside of grids */
        .panel > .form-group + .form-group {
            margin-top: 20px;
        }

        .form-label {
            display: block;
            font-weight: 500;
            margin-bottom: 8px;
            font-size: 13px;
            color: var(--text);
        }

        .form-hint {
            display: block;
            font-size: 11px;
            color: var(--text-muted);
            margin-bottom: 8px;
        }

        .form-control {
            width: 100%;
            padding: 11px 14px;
            background: var(--bg-input);
            border: 1px solid var(--border);
            border-radius: var(--radius-sm);
            color: var(--text);
            font-size: 14px;
            transition: all 0.2s ease;
        }

        .form-control:hover {
            border-color: var(--border-light);
        }

        .form-control:focus {
            outline: none;
            border-color: var(--accent);
            box-shadow: 0 0 0 3px var(--accent-glow);
            background: var(--bg-secondary);
        }

        .form-control[type="number"] {
            width: 100%;
            font-variant-numeric: tabular-nums;
        }

        select.form-control {
            width: 100%;
            cursor: pointer;
        }

        /* Grid Layout */
        .grid {
            display: grid;
            gap: 20px 28px;
            margin-bottom: 20px;
        }

        .grid:last-child {
            margin-bottom: 0;
        }

        .grid-2 { grid-template-columns: repeat(2, 1fr); }
        .grid-3 { grid-template-columns: repeat(3, 1fr); }
        .grid-4 { grid-template-columns: repeat(4, 1fr); }

        @media (max-width: 768px) {
            .grid-2, .grid-3, .grid-4 { grid-template-columns: 1fr; }
            .panel { padding: 20px; }
            .header { padding: 20px; }
        }

        @media (min-width: 769px) and (max-width: 900px) {
            .grid-3, .grid-4 { grid-template-columns: repeat(2, 1fr); }
        }

        /* Range Slider */
        .range-group {
            display: flex;
            align-items: center;
            gap: 16px;
        }

        .range-input {
            flex: 1;
            height: 6px;
            background: var(--bg-input);
            border-radius: 3px;
            outline: none;
            -webkit-appearance: none;
            border: 1px solid var(--border);
        }

        .range-input::-webkit-slider-thumb {
            -webkit-appearance: none;
            width: 20px;
            height: 20px;
            background: var(--accent);
            border-radius: 50%;
            cursor: pointer;
            box-shadow: 0 2px 6px rgba(233, 69, 96, 0.4);
            transition: transform 0.15s ease;
        }

        .range-input::-webkit-slider-thumb:hover {
            transform: scale(1.1);
        }

        .range-value {
            min-width: 55px;
            text-align: right;
            font-weight: 600;
            color: var(--accent);
            font-size: 14px;
            font-variant-numeric: tabular-nums;
        }

        /* Color Picker */
        .color-group {
            display: flex;
            align-items: center;
            gap: 14px;
        }

        .color-swatch {
            width: 52px;
            height: 42px;
            border-radius: var(--radius-sm);
            border: 2px solid var(--border);
            cursor: pointer;
            transition: all 0.2s ease;
        }

        .color-swatch:hover {
            transform: scale(1.05);
            border-color: var(--border-light);
        }

        .color-rgb {
            font-family: 'SF Mono', 'Fira Code', 'Courier New', monospace;
            font-size: 12px;
            color: var(--text-muted);
            letter-spacing: 0.3px;
        }

        /* Buttons */
        .btn-group {
            display: flex;
            gap: 14px;
            margin-top: 28px;
            padding-top: 28px;
            border-top: 1px solid var(--border);
        }

        .btn {
            flex: 1;
            padding: 13px 28px;
            border: none;
            border-radius: var(--radius-sm);
            font-size: 14px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s ease;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
        }

        .btn-primary {
            background: linear-gradient(135deg, var(--accent) 0%, var(--accent-hover) 100%);
            color: white;
            box-shadow: 0 4px 14px rgba(233, 69, 96, 0.35);
        }

        .btn-primary:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 20px rgba(233, 69, 96, 0.45);
        }

        .btn-secondary {
            background: var(--bg-input);
            color: var(--text);
            border: 1px solid var(--border);
        }

        .btn-secondary:hover {
            background: var(--bg-secondary);
            border-color: var(--border-light);
        }

        /* Alert */
        .alert {
            background: var(--accent-glow);
            border-left: 4px solid var(--accent);
            padding: 14px 18px;
            border-radius: var(--radius-sm);
            margin-bottom: 24px;
            font-size: 13px;
        }

        .alert strong {
            display: block;
            margin-bottom: 6px;
            color: var(--text);
        }

        .alert-warning {
            background: rgba(255, 140, 0, 0.12);
            border-left-color: #ff8c00;
        }

        /* Scrollbar */
        ::-webkit-scrollbar { width: 8px; height: 8px; }
        ::-webkit-scrollbar-track { background: var(--bg-primary); border-radius: 4px; }
        ::-webkit-scrollbar-thumb { background: var(--border); border-radius: 4px; }
        ::-webkit-scrollbar-thumb:hover { background: var(--accent); }

        /* Sensor Config Sections */
        .sensor-config-section {
            margin-bottom: 16px;
        }

        .sensor-config-section:last-child {
            margin-bottom: 0;
        }

        /* Collapsible details (used in Sensors + Layout tabs) */
        .sensor-details,
        .collapsible-details {
            border: 1px solid var(--border);
            border-radius: 8px;
            overflow: hidden;
        }

        .sensor-details summary,
        .collapsible-details summary {
            padding: 12px 16px;
            background: var(--bg-secondary);
            cursor: pointer;
            font-weight: 600;
            font-size: 15px;
            color: var(--text-primary);
            display: flex;
            align-items: center;
            gap: 8px;
            user-select: none;
            list-style: none;
            border-bottom: 1px solid transparent;
            transition: background 0.15s;
        }

        .sensor-details summary::-webkit-details-marker,
        .collapsible-details summary::-webkit-details-marker { display: none; }

        .sensor-details summary::before,
        .collapsible-details summary::before {
            content: '\25B6';
            font-size: 10px;
            transition: transform 0.2s;
            color: var(--text-dim);
        }

        .sensor-details[open] summary::before,
        .collapsible-details[open] summary::before {
            transform: rotate(90deg);
        }

        .sensor-details[open] summary,
        .collapsible-details[open] summary {
            border-bottom: 1px solid var(--border);
        }

        .sensor-details summary:hover,
        .collapsible-details summary:hover {
            background: var(--bg-primary);
        }

        .sensor-details-content,
        .collapsible-details-content {
            padding: 16px;
        }

        .sensor-details .sub-section-title,
        .collapsible-details .sub-section-title {
            font-size: 13px;
            font-weight: 600;
            color: var(--accent);
            text-transform: uppercase;
            letter-spacing: 0.5px;
            margin: 16px 0 8px 0;
            padding-bottom: 4px;
            border-bottom: 1px solid rgba(255,107,129,0.15);
        }

        .sensor-details .sub-section-title:first-child,
        .collapsible-details .sub-section-title:first-child {
            margin-top: 0;
        }
    </style>
</head>
<body>
    <div class="container">
        <!-- Header -->
        <div class="header">
            <h1>CoolerDash Configuration</h1>
            <p>Customize your LCD temperature dashboard &bull; Changes require plugin restart</p>
            <p style="margin-top: 8px; font-size: 12px; color: var(--text-dim); opacity: 0.8;">
                &#x1F4A1; <strong>Tip:</strong> After an update, click <em>Reset</em> to apply new default values. Feedback &amp; bug reports are welcome â€” see the <em>Info</em> tab for links.
            </p>
        </div>

        <!-- Tabs -->
        <div class="tabs">
            <button class="tab active" onclick="switchTab(0)">Connection</button>
            <button class="tab" onclick="switchTab(1)">Display</button>
            <button class="tab" onclick="switchTab(2)">Layout</button>
            <button class="tab" onclick="switchTab(3)">Colors</button>
            <button class="tab" onclick="switchTab(4)">Sensors</button>
            <button class="tab" onclick="switchTab(5)">Advanced</button>
            <button class="tab" onclick="switchTab(6)">Device</button>
            <button class="tab" onclick="switchTab(7)">Info</button>
        </div>

        <form id="configForm">
            <!-- Tab 0: Connection -->
            <div class="panel active">
                <div class="alert">
                    <strong>CoolerControl API</strong>
                    Make sure CoolerControl is running and the API is reachable.
                </div>

                <div class="form-group">
                    <label class="form-label">API Address</label>
                    <span class="form-hint">HTTP or HTTPS supported (Default: http://localhost:11987)</span>
                    <input type="text" name="daemon.address" class="form-control" required>
                </div>
                <div class="form-group">
                    <label class="form-label">API Password</label>
                    <span class="form-hint">Leave empty if authentication is disabled (Default: coolAdmin)</span>
                    <input type="password" name="daemon.password" class="form-control">
                </div>
            </div>

            <!-- Tab 1: Display -->
            <div class="panel">
                <h3 class="section-title">Display Mode</h3>

                <div class="grid grid-2">
                    <div class="form-group">
                        <label class="form-label">Display Mode</label>
                        <select name="display.mode" id="display_mode" class="form-control" onchange="toggleCircleInterval()">
                            <option value="dual">Dual (CPU + GPU simultaneously)</option>
                            <option value="circle">Circle (Alternating display)</option>
                        </select>
                    </div>

                    <div class="form-group" id="circle_interval_group" style="display: none;">
                        <label class="form-label">Switch Interval (Seconds)</label>
                        <span class="form-hint">How long each sensor is shown (Default: 5)</span>
                        <input type="number" name="display.circle_switch_interval" class="form-control" min="1" max="60" step="1">
                    </div>
                </div>

                <h3 class="section-title">Sensor Slots</h3>
                <div class="alert">
                    <strong>Sensor Assignment</strong>
                    Assign sensors to display positions. Use &ldquo;None&rdquo; to disable a slot.
                    Discovered sensors from CoolerControl API appear automatically.
                </div>

                <div class="grid grid-3">
                    <div class="form-group">
                        <label class="form-label">Upper Slot</label>
                        <span class="form-hint">Default: CPU</span>
                        <select name="display.sensor_slot_up" id="sensor_slot_up" class="form-control sensor-slot-select" onchange="validateSensorSlots()">
                            <optgroup label="Standard">
                                <option value="cpu">CPU</option>
                                <option value="gpu">GPU</option>
                                <option value="liquid">Liquid</option>
                                <option value="none">None</option>
                            </optgroup>
                        </select>
                    </div>

                    <div class="form-group" id="sensor_slot_mid_group">
                        <label class="form-label">Middle Slot</label>
                        <span class="form-hint">Default: None (Circle only)</span>
                        <select name="display.sensor_slot_mid" id="sensor_slot_mid" class="form-control sensor-slot-select" onchange="validateSensorSlots()">
                            <optgroup label="Standard">
                                <option value="cpu">CPU</option>
                                <option value="gpu">GPU</option>
                                <option value="liquid">Liquid</option>
                                <option value="none">None</option>
                            </optgroup>
                        </select>
                    </div>

                    <div class="form-group">
                        <label class="form-label">Lower Slot</label>
                        <span class="form-hint">Default: GPU</span>
                        <select name="display.sensor_slot_down" id="sensor_slot_down" class="form-control sensor-slot-select" onchange="validateSensorSlots()">
                            <optgroup label="Standard">
                                <option value="cpu">CPU</option>
                                <option value="gpu">GPU</option>
                                <option value="liquid">Liquid</option>
                                <option value="none">None</option>
                            </optgroup>
                        </select>
                    </div>
                </div>
                <div id="sensor_slot_warning" class="alert alert-warning" style="display: none;">
                    <strong>Warning</strong>
                    <span id="sensor_slot_warning_text"></span>
                </div>

                <h3 class="section-title">Timing &amp; Brightness</h3>
                <div class="grid grid-2">
                    <div class="form-group">
                        <label class="form-label">Refresh Interval (Seconds)</label>
                        <span class="form-hint">0.2 - 60 seconds (Default: 2.5)</span>
                        <input type="number" name="display.refresh_interval" class="form-control" min="0.2" max="60" step="0.1">
                    </div>

                    <div class="form-group">
                        <label class="form-label">Brightness (%)</label>
                        <span class="form-hint">Default: 80%</span>
                        <div class="range-group">
                            <input type="range" name="display.brightness" id="brightness" class="range-input" min="0" max="100" step="1" oninput="updateRangeValue('brightness', this.value)">
                            <span class="range-value" id="brightness_value">80%</span>
                        </div>
                    </div>
                </div>

                <h3 class="section-title">Display Geometry</h3>
                <div class="grid grid-2">
                    <div class="form-group">
                        <label class="form-label">Orientation</label>
                        <span class="form-hint">Default: 0&deg;</span>
                        <select name="display.orientation" class="form-control">
                            <option value="0">0&deg; (Default)</option>
                            <option value="90">90&deg; (Clockwise)</option>
                            <option value="180">180&deg; (Upside Down)</option>
                            <option value="270">270&deg; (Counter-Clockwise)</option>
                        </select>
                    </div>

                    <div class="form-group">
                        <label class="form-label">Shape</label>
                        <span class="form-hint">Default: Automatic</span>
                        <select name="display.shape" class="form-control">
                            <option value="auto">Automatic</option>
                            <option value="square">Square</option>
                            <option value="circle">Circle</option>
                        </select>
                    </div>
                </div>

                <div class="grid grid-2">
                    <div class="form-group">
                        <label class="form-label">Width (Pixels)</label>
                        <span class="form-hint">0 = automatic</span>
                        <input type="number" name="display.width" class="form-control" min="0" max="1024">
                    </div>

                    <div class="form-group">
                        <label class="form-label">Height (Pixels)</label>
                        <span class="form-hint">0 = automatic</span>
                        <input type="number" name="display.height" class="form-control" min="0" max="1024">
                    </div>
                </div>

                <div class="grid grid-2">
                    <div class="form-group">
                        <label class="form-label">Content Scale</label>
                        <span class="form-hint">Default: 0.98</span>
                        <input type="number" name="display.content_scale_factor" class="form-control" min="0.5" max="1.0" step="0.01">
                    </div>

                    <div class="form-group">
                        <label class="form-label">Inscribe Factor</label>
                        <span class="form-hint">Default: 0.707</span>
                        <input type="number" name="display.inscribe_factor" class="form-control" min="0.5" max="1.0" step="0.01">
                    </div>
                </div>
            </div>

            <!-- Tab 2: Layout -->
            <div class="panel">

                <details class="collapsible-details">
                    <summary>Bar Dimensions</summary>
                    <div class="collapsible-details-content">
                        <div class="grid grid-3">
                            <div class="form-group">
                                <label class="form-label">Default Bar Height</label>
                                <span class="form-hint">Default: 24</span>
                                <input type="number" name="layout.bar_height" class="form-control" min="10" max="100">
                            </div>
                            <div class="form-group">
                                <label class="form-label">Bar Width (%)</label>
                                <span class="form-hint">Default: 98</span>
                                <input type="number" name="layout.bar_width" class="form-control" min="50" max="100">
                            </div>
                            <div class="form-group">
                                <label class="form-label">Bar Gap</label>
                                <span class="form-hint">Default: 12</span>
                                <input type="number" name="layout.bar_gap" class="form-control" min="0" max="50">
                            </div>
                        </div>
                    </div>
                </details>

                <details class="collapsible-details" style="margin-top: 12px;">
                    <summary>Individual Bar Heights</summary>
                    <div class="collapsible-details-content">
                        <span class="form-hint" style="margin-bottom: 12px; display: block;">Set to 0 to use default bar height</span>
                        <div class="grid grid-3">
                            <div class="form-group">
                                <label class="form-label">Upper Slot Height</label>
                                <span class="form-hint">Default: 0</span>
                                <input type="number" name="layout.bar_height_up" class="form-control" min="0" max="100">
                            </div>
                            <div class="form-group" id="bar_height_mid_group">
                                <label class="form-label">Middle Slot Height</label>
                                <span class="form-hint">Default: 0</span>
                                <input type="number" name="layout.bar_height_mid" class="form-control" min="0" max="100">
                            </div>
                            <div class="form-group">
                                <label class="form-label">Lower Slot Height</label>
                                <span class="form-hint">Default: 0</span>
                                <input type="number" name="layout.bar_height_down" class="form-control" min="0" max="100">
                            </div>
                        </div>
                    </div>
                </details>

                <details class="collapsible-details" style="margin-top: 12px;">
                    <summary>Border &amp; Margins</summary>
                    <div class="collapsible-details-content">
                        <div class="grid grid-2">
                            <div class="form-group">
                                <label class="form-label">Show Border</label>
                                <span class="form-hint">Default: On</span>
                                <select name="layout.bar_border_enabled" class="form-control">
                                    <option value="1">On</option>
                                    <option value="0">Off</option>
                                </select>
                            </div>
                            <div class="form-group">
                                <label class="form-label">Border Thickness</label>
                                <span class="form-hint">Default: 1.0</span>
                                <input type="number" name="layout.bar_border" class="form-control" min="0" max="10" step="0.1">
                            </div>
                            <div class="form-group">
                                <label class="form-label">Label Left Margin</label>
                                <span class="form-hint">Default: 1</span>
                                <input type="number" name="layout.label_margin_left" class="form-control" min="0" max="20">
                            </div>
                            <div class="form-group">
                                <label class="form-label">Label Bar Margin</label>
                                <span class="form-hint">Default: 1</span>
                                <input type="number" name="layout.label_margin_bar" class="form-control" min="0" max="20">
                            </div>
                        </div>
                    </div>
                </details>

                <details class="collapsible-details" style="margin-top: 12px;">
                    <summary>Font</summary>
                    <div class="collapsible-details-content">
                        <div class="grid grid-3">
                            <div class="form-group">
                                <label class="form-label">Font Face</label>
                                <span class="form-hint">Default: Roboto Black</span>
                                <input type="text" name="font.face" class="form-control">
                            </div>
                            <div class="form-group">
                                <label class="form-label">Temperature Size (Global)</label>
                                <span class="form-hint">Default: 100 (per-sensor override in Sensors tab)</span>
                                <input type="number" name="font.size_temp" class="form-control" min="50" max="200">
                            </div>
                            <div class="form-group">
                                <label class="form-label">Label Size</label>
                                <span class="form-hint">Default: 30</span>
                                <input type="number" name="font.size_labels" class="form-control" min="10" max="100">
                            </div>
                        </div>
                    </div>
                </details>

                <details class="collapsible-details" style="margin-top: 12px;">
                    <summary>Global Positioning</summary>
                    <div class="collapsible-details-content">
                        <div class="alert">
                            <strong>Global Offsets</strong>
                            These offsets apply to all labels globally. Per-sensor value offsets are configured in the Sensors tab.
                        </div>
                        <div class="grid grid-3">
                            <div class="form-group">
                                <label class="form-label">Label X Offset</label>
                                <span class="form-hint">Default: 0</span>
                                <input type="number" name="positioning.label_offset_x" class="form-control" step="1">
                            </div>
                            <div class="form-group">
                                <label class="form-label">Label Y Offset</label>
                                <span class="form-hint">Default: 0</span>
                                <input type="number" name="positioning.label_offset_y" class="form-control" step="1">
                            </div>
                            <div class="form-group">
                                <label class="form-label">Degree Symbol Spacing</label>
                                <span class="form-hint">Default: 16</span>
                                <input type="number" name="positioning.degree_spacing" class="form-control" min="0" max="50">
                            </div>
                        </div>
                    </div>
                </details>

            </div>

            <!-- Tab 3: Colors -->
            <div class="panel">
                <h3 class="section-title">Display Colors</h3>
                <div class="grid grid-2">
                    <div class="form-group">
                        <label class="form-label">Display Background</label>
                        <div class="color-group">
                            <input type="color" id="color_display_background" class="color-swatch" onchange="updateColorRGB('color_display_background', 'rgb_display_background')">
                            <span class="color-rgb" id="rgb_display_background"></span>
                        </div>
                    </div>

                    <div class="form-group">
                        <label class="form-label">Bar Background</label>
                        <div class="color-group">
                            <input type="color" id="color_bar_background" class="color-swatch" onchange="updateColorRGB('color_bar_background', 'rgb_bar_background')">
                            <span class="color-rgb" id="rgb_bar_background"></span>
                        </div>
                    </div>

                    <div class="form-group">
                        <label class="form-label">Bar Border</label>
                        <div class="color-group">
                            <input type="color" id="color_bar_border" class="color-swatch" onchange="updateColorRGB('color_bar_border', 'rgb_bar_border')">
                            <span class="color-rgb" id="rgb_bar_border"></span>
                        </div>
                    </div>
                </div>

                <h3 class="section-title">Text Colors</h3>
                <div class="grid grid-2">
                    <div class="form-group">
                        <label class="form-label">Temperature Text</label>
                        <div class="color-group">
                            <input type="color" id="color_font_temp" class="color-swatch" onchange="updateColorRGB('color_font_temp', 'rgb_font_temp')">
                            <span class="color-rgb" id="rgb_font_temp"></span>
                        </div>
                    </div>

                    <div class="form-group">
                        <label class="form-label">Label Text</label>
                        <div class="color-group">
                            <input type="color" id="color_font_label" class="color-swatch" onchange="updateColorRGB('color_font_label', 'rgb_font_label')">
                            <span class="color-rgb" id="rgb_font_label"></span>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Tab 4: Sensors -->
            <div class="panel">
                <div class="alert">
                    <strong>Sensor Configuration</strong>
                    Configure thresholds, bar colors, and position offsets for each sensor assigned to a display slot.
                    New sensors are automatically added when assigned in the Display tab.
                </div>
                <div id="sensor-config-container">
                    <p style="color: var(--text-dim); text-align: center; padding: 20px;">
                        Loading sensor configurations...
                    </p>
                </div>
            </div>

            <!-- Tab 5: Advanced -->
            <div class="panel">
                <h3 class="section-title">Image Paths</h3>

                <div class="form-group">
                    <label class="form-label">Shutdown Image</label>
                    <span class="form-hint">Image displayed when daemon stops (Default: /etc/coolercontrol/plugins/coolerdash/shutdown.png)</span>
                    <input type="text" name="paths.image_shutdown" class="form-control">
                </div>

                <h3 class="section-title">Backup &amp; Restore</h3>
                <div class="alert">
                    <strong>Configuration Backup</strong>
                    Export your current settings as a JSON file for backup or migration.
                </div>
                <button type="button" class="btn btn-secondary" onclick="exportConfig()" style="width: auto; padding: 10px 20px;">
                    &#x1F4BE; Export Configuration
                </button>
            </div>

            <!-- Tab 6: Device -->
            <div class="panel">
                <h3 class="section-title">Detected LCD Device</h3>

                <div id="device-loading" class="alert" style="opacity: 0.7;">
                    Detecting device from CoolerControl API...
                </div>

                <div id="device-panel-content" style="display: none;">
                    <div class="device-info-card">
                        <div class="device-info-row">
                            <span class="device-info-label">Status</span>
                            <span class="device-info-value" id="device-status">
                                <span class="device-status disconnected">
                                    <span class="device-status-dot"></span> Waiting
                                </span>
                            </span>
                        </div>
                        <div class="device-info-row">
                            <span class="device-info-label">Device Name</span>
                            <span class="device-info-value" id="device-name">&mdash;</span>
                        </div>
                        <div class="device-info-row">
                            <span class="device-info-label">Device UID</span>
                            <span class="device-info-value mono" id="device-uid">&mdash;</span>
                        </div>
                        <div class="device-info-row">
                            <span class="device-info-label">LCD Resolution</span>
                            <span class="device-info-value mono" id="device-resolution">&mdash;</span>
                        </div>
                        <div class="device-info-row">
                            <span class="device-info-label">Display Shape</span>
                            <span class="device-info-value" id="device-shape">&mdash;</span>
                        </div>
                        <div class="device-info-row">
                            <span class="device-info-label">Firmware</span>
                            <span class="device-info-value mono" id="device-firmware">&mdash;</span>
                        </div>
                        <div class="device-info-row">
                            <span class="device-info-label">Liquidctl Version</span>
                            <span class="device-info-value mono" id="device-liquidctl">&mdash;</span>
                        </div>
                    </div>

                    <button type="button" class="btn btn-secondary" onclick="refreshDeviceInfo()" style="width: auto; padding: 10px 20px; margin-top: 8px;">
                        &#x1F504; Refresh Device Info
                    </button>
                </div>

                <div id="device-error" class="alert alert-warning" style="display: none;">
                    <strong>Detection Failed</strong>
                    <span id="device-error-text">Could not connect to CoolerControl API.</span>
                </div>
            </div>

            <!-- Tab 7: Info -->
            <div class="panel">
                <h3 class="section-title">About CoolerDash</h3>

                <div class="device-info-card">
                    <div class="info-item">
                        <div class="info-item-label">Plugin</div>
                        <div class="info-item-value">CoolerDash v{{VERSION}} &mdash; LCD Temperature Dashboard</div>
                    </div>
                    <div class="info-item">
                        <div class="info-item-label">Description</div>
                        <div class="info-item-value" style="color: var(--text-dim);">Displays CPU, GPU, and Liquid temperatures on AIO liquid cooler LCD screens (NZXT Kraken, etc.)</div>
                    </div>
                    <div class="info-item">
                        <div class="info-item-label">Author</div>
                        <div class="info-item-value">damachine</div>
                    </div>
                    <div class="info-item">
                        <div class="info-item-label">Website</div>
                        <div class="info-item-value"><a href="https://github.com/damachine/coolerdash" target="_blank" rel="noopener">github.com/damachine/coolerdash</a></div>
                    </div>
                    <div class="info-item">
                        <div class="info-item-label">License</div>
                        <div class="info-item-value">MIT</div>
                    </div>
                    <div class="info-item" style="margin-bottom: 0;">
                        <div class="info-item-label">Language / Platform</div>
                        <div class="info-item-value">C99 / Linux (systemd)</div>
                    </div>
                </div>

                <h3 class="section-title">Community &amp; Feedback</h3>

                <div class="device-info-card">
                    <div class="info-item">
                        <div class="info-item-label">Bug Reports &amp; Feature Requests</div>
                        <div class="info-item-value"><a href="https://github.com/damachine/coolerdash/issues" target="_blank" rel="noopener">GitHub Issues</a></div>
                    </div>
                    <div class="info-item">
                        <div class="info-item-label">Discussions</div>
                        <div class="info-item-value"><a href="https://github.com/damachine/coolerdash/discussions" target="_blank" rel="noopener">GitHub Discussions</a></div>
                    </div>
                    <div class="info-item" style="margin-bottom: 0;">
                        <div class="info-item-label">Discord</div>
                        <div class="info-item-value"><a href="https://discord.com/channels/908873022105079848/1461781766791499981" target="_blank" rel="noopener">CoolerControl Discord &mdash; #coolerdash</a></div>
                    </div>
                </div>

                <h3 class="section-title">System Environment</h3>

                <div class="device-info-card">
                    <div class="device-info-row">
                        <span class="device-info-label">Kernel</span>
                        <span class="device-info-value mono" id="sys-kernel">&mdash;</span>
                    </div>
                    <div class="device-info-row">
                        <span class="device-info-label">CoolerControl Version</span>
                        <span class="device-info-value mono" id="sys-cc-version">&mdash;</span>
                    </div>
                </div>
            </div>
        </form>

        <!-- Buttons -->
        <div class="btn-group">
            <button type="button" class="btn btn-primary" onclick="saveConfig()">Save</button>
            <button type="button" class="btn btn-secondary" onclick="resetConfig()">Reset</button>
        </div>

        <!-- Restart Notice -->
        <div style="margin-top: 16px; padding: 12px; background: rgba(255, 140, 0, 0.05); border-left: 3px solid #ff8c00; border-radius: 4px;">
            <p style="margin: 0; color: var(--text-dim); font-size: 13px;">
                <strong>Note:</strong> Changes are applied immediately &mdash; the plugin will be restarted automatically after Save or Reset.
            </p>
        </div>
    </div>

    <script>
        // ===== FACTORY DEFAULT CONFIGURATION =====
        const FACTORY_DEFAULTS = {
            daemon: {
                address: "http://localhost:11987",
                password: "coolAdmin"
            },
            paths: {
                image_shutdown: "/etc/coolercontrol/plugins/coolerdash/shutdown.png"
            },
            display: {
                mode: "dual",
                circle_switch_interval: 5,
                refresh_interval: 2.5,
                brightness: 80,
                orientation: 0,
                width: 0,
                height: 0,
                shape: "auto",
                content_scale_factor: 0.98,
                inscribe_factor: 0.70710678,
                sensor_slot_up: "cpu",
                sensor_slot_mid: "liquid",
                sensor_slot_down: "gpu"
            },
            layout: {
                bar_height: 24,
                bar_width: 98,
                bar_gap: 12,
                bar_border: 1.0,
                bar_border_enabled: 1,
                label_margin_left: 1,
                label_margin_bar: 1,
                bar_height_up: 0,
                bar_height_mid: 0,
                bar_height_down: 0
            },
            colors: {
                display_background: { r: 0, g: 0, b: 0 },
                bar_background: { r: 52, g: 52, b: 52 },
                bar_border: { r: 192, g: 192, b: 192 },
                font_temp: { r: 255, g: 255, b: 255 },
                font_label: { r: 200, g: 200, b: 200 }
            },
            font: {
                face: "Roboto Black",
                size_temp: 100.0,
                size_labels: 30.0
            },
            sensors: {
                cpu: {
                    threshold_1: 55.0,
                    threshold_2: 65.0,
                    threshold_3: 75.0,
                    max_scale: 115.0,
                    font_size_temp: 0,
                    label: '',
                    threshold_1_color: { r: 0, g: 255, b: 0 },
                    threshold_2_color: { r: 255, g: 140, b: 0 },
                    threshold_3_color: { r: 255, g: 70, b: 0 },
                    threshold_4_color: { r: 255, g: 0, b: 0 },
                    offset_x: 0,
                    offset_y: 0
                },
                gpu: {
                    threshold_1: 55.0,
                    threshold_2: 65.0,
                    threshold_3: 75.0,
                    max_scale: 115.0,
                    font_size_temp: 0,
                    label: '',
                    threshold_1_color: { r: 0, g: 255, b: 0 },
                    threshold_2_color: { r: 255, g: 140, b: 0 },
                    threshold_3_color: { r: 255, g: 70, b: 0 },
                    threshold_4_color: { r: 255, g: 0, b: 0 },
                    offset_x: 0,
                    offset_y: 0
                },
                liquid: {
                    threshold_1: 25.0,
                    threshold_2: 28.0,
                    threshold_3: 31.0,
                    max_scale: 50.0,
                    font_size_temp: 0,
                    label: '',
                    threshold_1_color: { r: 0, g: 255, b: 0 },
                    threshold_2_color: { r: 255, g: 140, b: 0 },
                    threshold_3_color: { r: 255, g: 70, b: 0 },
                    threshold_4_color: { r: 255, g: 0, b: 0 },
                    offset_x: 0,
                    offset_y: 0
                }
            },
            positioning: {
                degree_spacing: 16,
                label_offset_x: 0,
                label_offset_y: 0
            }
        };

        let DEFAULT_CONFIG = null;
        let currentTab = 0;
        let discoveredSensors = [];
        let currentSensorConfig = {};

        // ===== FALLBACK FUNCTIONS =====
        const isInCoolerControl = window.parent !== window;

        if (typeof savePluginConfig === 'undefined') {
            window.savePluginConfig = async function(config) {
                if (isInCoolerControl) {
                    return new Promise((resolve, reject) => {
                        const messageHandler = (event) => {
                            if (event.data.type === 'configSaved') {
                                window.removeEventListener('message', messageHandler);
                                if (event.data.body) resolve(event.data.body);
                                else reject(new Error('Config save failed'));
                            }
                        };
                        window.addEventListener('message', messageHandler);
                        window.parent.postMessage({ type: 'saveConfig', body: config }, document.location.origin);
                        setTimeout(() => {
                            window.removeEventListener('message', messageHandler);
                            reject(new Error('Save timeout'));
                        }, 5000);
                    });
                } else {
                    localStorage.setItem('coolerdash_config', JSON.stringify(config));
                    return Promise.resolve(config);
                }
            };
        }

        if (typeof getPluginConfig === 'undefined') {
            window.getPluginConfig = async function() {
                if (isInCoolerControl) {
                    return new Promise((resolve) => {
                        const messageHandler = (event) => {
                            if (event.data.type === 'config') {
                                window.removeEventListener('message', messageHandler);
                                resolve(event.data.body || {});
                            }
                        };
                        window.addEventListener('message', messageHandler);
                        window.parent.postMessage({ type: 'loadConfig' }, document.location.origin);
                        setTimeout(() => {
                            window.removeEventListener('message', messageHandler);
                            resolve({});
                        }, 3000);
                    });
                } else {
                    const saved = localStorage.getItem('coolerdash_config');
                    return Promise.resolve(saved ? JSON.parse(saved) : {});
                }
            };
        }

        if (typeof runPluginScript === 'undefined') {
            window.runPluginScript = function(mainFunction) { mainFunction(); };
        }

        // ===== SENSOR DISCOVERY =====
        async function discoverSensors(apiAddress, password) {
            try {
                const headers = { 'Content-Type': 'application/json' };
                if (password) {
                    headers['Authorization'] = 'Basic ' + btoa('admin:' + password);
                }

                // GET /devices for device names
                const devRes = await fetch(apiAddress + '/devices', { headers: password ? { 'Authorization': headers['Authorization'] } : {} });
                const devData = devRes.ok ? await devRes.json() : { devices: [] };
                const deviceNames = {};
                for (const dev of (devData.devices || [])) {
                    if (dev.uid) deviceNames[dev.uid] = dev.name || dev.uid;
                }

                // POST /status for current sensor data
                const statusRes = await fetch(apiAddress + '/status', { method: 'POST', headers, body: '{}' });
                if (!statusRes.ok) return;
                const statusData = await statusRes.json();

                const sensors = [];
                for (const dev of (statusData.devices || [])) {
                    const uid = dev.uid || '';
                    const devName = deviceNames[uid] || uid;
                    const lastStatus = Array.isArray(dev.status_history) && dev.status_history.length > 0
                        ? dev.status_history[dev.status_history.length - 1]
                        : {};

                    // Temperature sensors
                    const temps = lastStatus.temps || [];
                    for (const t of temps) {
                        if (t.temp !== undefined && t.temp > -50 && t.temp < 200) {
                            sensors.push({
                                id: uid + ':' + t.name,
                                label: devName + ' \u2014 ' + t.name,
                                device: devName,
                                name: t.name,
                                category: 'temp'
                            });
                        }
                    }

                    // Channel sensors (RPM, Duty, Watts, Freq)
                    const channels = lastStatus.channels || [];
                    for (const ch of channels) {
                        if (ch.rpm !== undefined) {
                            sensors.push({
                                id: uid + ':' + ch.name + ' RPM',
                                label: devName + ' \u2014 ' + ch.name + ' RPM',
                                device: devName,
                                name: ch.name + ' RPM',
                                category: 'rpm'
                            });
                        }
                        if (ch.duty !== undefined) {
                            sensors.push({
                                id: uid + ':' + ch.name + ' Duty',
                                label: devName + ' \u2014 ' + ch.name + ' Duty',
                                device: devName,
                                name: ch.name + ' Duty',
                                category: 'duty'
                            });
                        }
                        if (ch.watts !== undefined) {
                            sensors.push({
                                id: uid + ':' + ch.name + ' Watts',
                                label: devName + ' \u2014 ' + ch.name + ' Watts',
                                device: devName,
                                name: ch.name + ' Watts',
                                category: 'watts'
                            });
                        }
                        if (ch.freq !== undefined) {
                            sensors.push({
                                id: uid + ':' + ch.name + ' Freq',
                                label: devName + ' \u2014 ' + ch.name + ' Freq',
                                device: devName,
                                name: ch.name + ' Freq',
                                category: 'freq'
                            });
                        }
                    }
                }

                discoveredSensors = sensors;
                updateSensorSlotOptions();
                // Re-render sensor configs to update display names
                if (Object.keys(currentSensorConfig).length > 0) {
                    renderSensorConfigs({ sensors: currentSensorConfig });
                }
            } catch (error) {
                console.warn('Sensor discovery failed:', error);
            }
        }

        function updateSensorSlotOptions() {
            var selects = document.querySelectorAll('.sensor-slot-select');
            for (var i = 0; i < selects.length; i++) {
                var select = selects[i];
                var currentValue = select.value;

                // Remove old dynamic optgroups (keep first "Standard" group)
                var groups = select.querySelectorAll('optgroup');
                for (var g = groups.length - 1; g >= 1; g--) {
                    select.removeChild(groups[g]);
                }
                // Also remove any loose options outside optgroups
                var looseOpts = select.querySelectorAll(':scope > option');
                for (var lo = 0; lo < looseOpts.length; lo++) {
                    select.removeChild(looseOpts[lo]);
                }

                // Group discovered sensors by device
                if (discoveredSensors.length > 0) {
                    var byDevice = {};
                    for (var s = 0; s < discoveredSensors.length; s++) {
                        var sensor = discoveredSensors[s];
                        if (!byDevice[sensor.device]) byDevice[sensor.device] = [];
                        byDevice[sensor.device].push(sensor);
                    }
                    for (var device in byDevice) {
                        if (!byDevice.hasOwnProperty(device)) continue;
                        var group = document.createElement('optgroup');
                        group.label = device;
                        var deviceSensors = byDevice[device];
                        deviceSensors.sort(function(a, b) {
                            return a.name.localeCompare(b.name);
                        });
                        for (var ds = 0; ds < deviceSensors.length; ds++) {
                            var opt = document.createElement('option');
                            opt.value = deviceSensors[ds].id;
                            opt.textContent = deviceSensors[ds].name;
                            group.appendChild(opt);
                        }
                        select.appendChild(group);
                    }
                }

                // Restore selected value
                if (currentValue) {
                    var exists = false;
                    for (var oi = 0; oi < select.options.length; oi++) {
                        if (select.options[oi].value === currentValue) { exists = true; break; }
                    }
                    if (exists) {
                        select.value = currentValue;
                    } else if (currentValue !== 'none' && currentValue !== '') {
                        // Add as custom option if not found (e.g. sensor not currently connected)
                        var customOpt = document.createElement('option');
                        customOpt.value = currentValue;
                        customOpt.textContent = getSensorDisplayName(currentValue);
                        select.insertBefore(customOpt, select.firstChild);
                        select.value = currentValue;
                    }
                }
            }
        }

        // ===== SENSOR CONFIG DEFAULTS =====
        function getDefaultSensorConfig(sensorId) {
            var defaults = {
                threshold_1: 55.0, threshold_2: 65.0, threshold_3: 75.0, max_scale: 115.0,
                font_size_temp: 0, label: '',
                threshold_1_color: { r: 0, g: 255, b: 0 },
                threshold_2_color: { r: 255, g: 140, b: 0 },
                threshold_3_color: { r: 255, g: 70, b: 0 },
                threshold_4_color: { r: 255, g: 0, b: 0 },
                offset_x: 0, offset_y: 0
            };

            if (sensorId === 'liquid') {
                defaults.threshold_1 = 25.0;
                defaults.threshold_2 = 28.0;
                defaults.threshold_3 = 31.0;
                defaults.max_scale = 50.0;
            } else if (/RPM|rpm/.test(sensorId)) {
                defaults.threshold_1 = 500;
                defaults.threshold_2 = 1000;
                defaults.threshold_3 = 1500;
                defaults.max_scale = 3000;
            } else if (/Duty|duty/.test(sensorId)) {
                defaults.threshold_1 = 25;
                defaults.threshold_2 = 50;
                defaults.threshold_3 = 75;
                defaults.max_scale = 100;
            } else if (/Watts|watts/.test(sensorId)) {
                defaults.threshold_1 = 50;
                defaults.threshold_2 = 100;
                defaults.threshold_3 = 200;
                defaults.max_scale = 500;
            } else if (/Freq|freq/.test(sensorId)) {
                defaults.threshold_1 = 1000;
                defaults.threshold_2 = 2000;
                defaults.threshold_3 = 3000;
                defaults.max_scale = 6000;
            }

            return defaults;
        }

        function getSensorDisplayName(sensorId) {
            var legacyNames = { cpu: 'CPU', gpu: 'GPU', liquid: 'Liquid' };
            if (legacyNames[sensorId]) return legacyNames[sensorId];
            var found = null;
            for (var i = 0; i < discoveredSensors.length; i++) {
                if (discoveredSensors[i].id === sensorId) { found = discoveredSensors[i]; break; }
            }
            if (found) return found.label;
            // Fallback: show the raw ID
            return sensorId;
        }

        // ===== DYNAMIC SENSOR CONFIG UI =====
        function renderSensorConfigs(config) {
            var container = document.getElementById('sensor-config-container');
            if (!container) return;

            var sensors = config.sensors || {};

            // Ensure all discovered sensors have a config entry
            for (var d = 0; d < discoveredSensors.length; d++) {
                var dsId = discoveredSensors[d].id;
                if (!sensors[dsId]) {
                    sensors[dsId] = getDefaultSensorConfig(dsId);
                }
            }

            var sensorIds = Object.keys(sensors);

            // Filter out dynamic sensors that duplicate a legacy sensor
            // e.g. if "liquid" exists, skip any "<uid>:liquid" entry
            var legacyNames = { cpu: true, gpu: true, liquid: true };
            sensorIds = sensorIds.filter(function(id) {
                if (legacyNames[id]) return true; // keep legacy entries
                var colonIdx = id.indexOf(':');
                if (colonIdx < 0) return true; // not dynamic
                var sensorName = id.substring(colonIdx + 1).toLowerCase();
                // Skip if a legacy key matches the sensor name
                if (sensorName === 'liquid' && sensors['liquid']) return false;
                if (sensorName === 'cpu' && sensors['cpu']) return false;
                if (sensorName === 'gpu' && sensors['gpu']) return false;
                return true;
            });

            // Sort: cpu/gpu/liquid always first, then alphabetically by display name
            var legacyOrder = { cpu: 0, gpu: 1, liquid: 2 };
            sensorIds.sort(function(a, b) {
                var aLegacy = legacyOrder.hasOwnProperty(a) ? legacyOrder[a] : 99;
                var bLegacy = legacyOrder.hasOwnProperty(b) ? legacyOrder[b] : 99;
                if (aLegacy !== bLegacy) return aLegacy - bLegacy;
                return getSensorDisplayName(a).localeCompare(getSensorDisplayName(b));
            });

            if (sensorIds.length === 0) {
                container.innerHTML = '<p style="color: var(--text-dim); text-align: center; padding: 20px;">No sensor configurations found. Assign sensors in the Display tab.</p>';
                return;
            }

            container.innerHTML = '';

            for (var si = 0; si < sensorIds.length; si++) {
                var sensorId = sensorIds[si];
                var sc = sensors[sensorId];
                var safeName = sensorId.replace(/[^a-zA-Z0-9]/g, '_');
                var displayName = getSensorDisplayName(sensorId);
                var defs = getDefaultSensorConfig(sensorId);

                var section = document.createElement('div');
                section.className = 'sensor-config-section';
                section.setAttribute('data-sensor-id', sensorId);

                section.innerHTML =
                    '<details class="sensor-details">' +
                        '<summary>' + displayName + '</summary>' +
                        '<div class="sensor-details-content">' +

                            // Display section
                            '<div class="sub-section-title">Display</div>' +
                            '<div class="grid grid-4">' +
                                '<div class="form-group">' +
                                    '<label class="form-label">Label</label>' +
                                    '<span class="form-hint">Custom label (empty = auto)</span>' +
                                    '<input type="text" data-sensor="' + sensorId + '" data-field="label" class="form-control sensor-field" value="' + (sc.label || '') + '" maxlength="31" placeholder="auto">' +
                                '</div>' +
                                '<div class="form-group">' +
                                    '<label class="form-label">Font Size</label>' +
                                    '<span class="form-hint">Default: 100 (0 = global)</span>' +
                                    '<input type="number" data-sensor="' + sensorId + '" data-field="font_size_temp" class="form-control sensor-field" value="' + (sc.font_size_temp || 0) + '" min="0" max="300" step="1">' +
                                '</div>' +
                                '<div class="form-group">' +
                                    '<label class="form-label">X Offset</label>' +
                                    '<span class="form-hint">Default: 0</span>' +
                                    '<input type="number" data-sensor="' + sensorId + '" data-field="offset_x" class="form-control sensor-field" value="' + (sc.offset_x || 0) + '" step="1">' +
                                '</div>' +
                                '<div class="form-group">' +
                                    '<label class="form-label">Y Offset</label>' +
                                    '<span class="form-hint">Default: 0</span>' +
                                    '<input type="number" data-sensor="' + sensorId + '" data-field="offset_y" class="form-control sensor-field" value="' + (sc.offset_y || 0) + '" step="1">' +
                                '</div>' +
                            '</div>' +

                            // Thresholds section
                            '<div class="sub-section-title">Thresholds</div>' +
                            '<div class="grid grid-4">' +
                                '<div class="form-group">' +
                                    '<label class="form-label">Threshold 1</label>' +
                                    '<span class="form-hint">Default: ' + defs.threshold_1 + '</span>' +
                                    '<input type="number" data-sensor="' + sensorId + '" data-field="threshold_1" class="form-control sensor-field" value="' + (sc.threshold_1 !== undefined ? sc.threshold_1 : defs.threshold_1) + '" step="0.1">' +
                                '</div>' +
                                '<div class="form-group">' +
                                    '<label class="form-label">Threshold 2</label>' +
                                    '<span class="form-hint">Default: ' + defs.threshold_2 + '</span>' +
                                    '<input type="number" data-sensor="' + sensorId + '" data-field="threshold_2" class="form-control sensor-field" value="' + (sc.threshold_2 !== undefined ? sc.threshold_2 : defs.threshold_2) + '" step="0.1">' +
                                '</div>' +
                                '<div class="form-group">' +
                                    '<label class="form-label">Threshold 3</label>' +
                                    '<span class="form-hint">Default: ' + defs.threshold_3 + '</span>' +
                                    '<input type="number" data-sensor="' + sensorId + '" data-field="threshold_3" class="form-control sensor-field" value="' + (sc.threshold_3 !== undefined ? sc.threshold_3 : defs.threshold_3) + '" step="0.1">' +
                                '</div>' +
                                '<div class="form-group">' +
                                    '<label class="form-label">Max Scale</label>' +
                                    '<span class="form-hint">Default: ' + defs.max_scale + '</span>' +
                                    '<input type="number" data-sensor="' + sensorId + '" data-field="max_scale" class="form-control sensor-field" value="' + (sc.max_scale !== undefined ? sc.max_scale : defs.max_scale) + '" step="0.1">' +
                                '</div>' +
                            '</div>' +

                            // Bar Colors section
                            '<div class="sub-section-title">Bar Colors</div>' +
                            '<div class="grid grid-4">' +
                                '<div class="form-group">' +
                                    '<label class="form-label">&lt; Threshold 1</label>' +
                                    '<div class="color-group">' +
                                        '<input type="color" id="color_' + safeName + '_1" class="color-swatch" onchange="updateColorRGB(\'color_' + safeName + '_1\', \'rgb_' + safeName + '_1\')">' +
                                        '<span class="color-rgb" id="rgb_' + safeName + '_1"></span>' +
                                    '</div>' +
                                '</div>' +
                                '<div class="form-group">' +
                                    '<label class="form-label">Threshold 1-2</label>' +
                                    '<div class="color-group">' +
                                        '<input type="color" id="color_' + safeName + '_2" class="color-swatch" onchange="updateColorRGB(\'color_' + safeName + '_2\', \'rgb_' + safeName + '_2\')">' +
                                        '<span class="color-rgb" id="rgb_' + safeName + '_2"></span>' +
                                    '</div>' +
                                '</div>' +
                                '<div class="form-group">' +
                                    '<label class="form-label">Threshold 2-3</label>' +
                                    '<div class="color-group">' +
                                        '<input type="color" id="color_' + safeName + '_3" class="color-swatch" onchange="updateColorRGB(\'color_' + safeName + '_3\', \'rgb_' + safeName + '_3\')">' +
                                        '<span class="color-rgb" id="rgb_' + safeName + '_3"></span>' +
                                    '</div>' +
                                '</div>' +
                                '<div class="form-group">' +
                                    '<label class="form-label">&gt; Threshold 3</label>' +
                                    '<div class="color-group">' +
                                        '<input type="color" id="color_' + safeName + '_4" class="color-swatch" onchange="updateColorRGB(\'color_' + safeName + '_4\', \'rgb_' + safeName + '_4\')">' +
                                        '<span class="color-rgb" id="rgb_' + safeName + '_4"></span>' +
                                    '</div>' +
                                '</div>' +
                            '</div>' +

                        '</div>' +
                    '</details>';

                container.appendChild(section);

                // Setup color pickers after DOM insertion
                setupColorPicker('color_' + safeName + '_1', 'rgb_' + safeName + '_1', sc.threshold_1_color || defs.threshold_1_color);
                setupColorPicker('color_' + safeName + '_2', 'rgb_' + safeName + '_2', sc.threshold_2_color || defs.threshold_2_color);
                setupColorPicker('color_' + safeName + '_3', 'rgb_' + safeName + '_3', sc.threshold_3_color || defs.threshold_3_color);
                setupColorPicker('color_' + safeName + '_4', 'rgb_' + safeName + '_4', sc.threshold_4_color || defs.threshold_4_color);
            }

            // Store reference for buildConfig
            currentSensorConfig = sensors;
        }

        function ensureSensorConfigsForSlots() {
            var slotIds = ['sensor_slot_up', 'sensor_slot_mid', 'sensor_slot_down'];
            var activeSensors = [];

            for (var i = 0; i < slotIds.length; i++) {
                var select = document.getElementById(slotIds[i]);
                if (select && select.value !== 'none' && select.value !== '') {
                    if (activeSensors.indexOf(select.value) === -1) {
                        activeSensors.push(select.value);
                    }
                }
            }

            // Check if any sensor is missing from the config
            var needsRebuild = false;
            for (var s = 0; s < activeSensors.length; s++) {
                if (!currentSensorConfig[activeSensors[s]]) {
                    needsRebuild = true;
                    break;
                }
            }

            if (needsRebuild) {
                // Collect current values from DOM
                var sensors = collectSensorConfigsFromDOM();
                // Add defaults for new sensors
                for (var ns = 0; ns < activeSensors.length; ns++) {
                    if (!sensors[activeSensors[ns]]) {
                        sensors[activeSensors[ns]] = getDefaultSensorConfig(activeSensors[ns]);
                    }
                }
                currentSensorConfig = sensors;
                renderSensorConfigs({ sensors: sensors });
            }
        }

        function collectSensorConfigsFromDOM() {
            var sensors = {};
            var sections = document.querySelectorAll('.sensor-config-section');
            for (var i = 0; i < sections.length; i++) {
                var section = sections[i];
                var sensorId = section.getAttribute('data-sensor-id');
                if (!sensorId) continue;

                var safeName = sensorId.replace(/[^a-zA-Z0-9]/g, '_');
                var sc = {};

                // Threshold/offset fields
                var fields = section.querySelectorAll('.sensor-field');
                for (var f = 0; f < fields.length; f++) {
                    var field = fields[f].getAttribute('data-field');
                    if (field) {
                        var numVal = parseFloat(fields[f].value);
                        sc[field] = isNaN(numVal) ? fields[f].value : numVal;
                    }
                }

                // Colors
                sc.threshold_1_color = getColorFromPicker('color_' + safeName + '_1');
                sc.threshold_2_color = getColorFromPicker('color_' + safeName + '_2');
                sc.threshold_3_color = getColorFromPicker('color_' + safeName + '_3');
                sc.threshold_4_color = getColorFromPicker('color_' + safeName + '_4');

                sensors[sensorId] = sc;
            }
            return sensors;
        }

        // ===== DEVICE DETECTION =====
        var lastApiAddress = '';
        var lastApiPassword = '';

        async function fetchDeviceInfo(apiAddress, password) {
            lastApiAddress = apiAddress;
            lastApiPassword = password;

            var loadingEl = document.getElementById('device-loading');
            var contentEl = document.getElementById('device-panel-content');
            var errorEl = document.getElementById('device-error');

            loadingEl.style.display = 'block';
            contentEl.style.display = 'none';
            errorEl.style.display = 'none';

            try {
                var headers = {};
                if (password) {
                    headers['Authorization'] = 'Basic ' + btoa('admin:' + password);
                }
                var response = await fetch(apiAddress + '/devices', { headers: headers });
                if (!response.ok) throw new Error('HTTP ' + response.status);
                var data = await response.json();

                var devices = data.devices || [];
                var found = null;
                for (var i = 0; i < devices.length; i++) {
                    var dev = devices[i];
                    var dtype = dev.type || '';
                    if (dtype === 'Liquidctl') {
                        var lcdInfo = dev.info && dev.info.channels && dev.info.channels.lcd && dev.info.channels.lcd.lcd_info;
                        if (lcdInfo && lcdInfo.screen_width > 0 && lcdInfo.screen_height > 0) {
                            found = dev;
                            break;
                        }
                    }
                }

                loadingEl.style.display = 'none';

                if (found) {
                    var name = found.name || 'Unknown Device';
                    var uid = found.uid || '\u2014';
                    document.getElementById('device-name').textContent = name;
                    document.getElementById('device-uid').textContent = uid;

                    var firmware = (found.lc_info && found.lc_info.firmware_version) || '\u2014';
                    document.getElementById('device-firmware').textContent = firmware;

                    var liquidctlVer = (found.info && found.info.driver_info && found.info.driver_info.version) || '\u2014';
                    document.getElementById('device-liquidctl').textContent = liquidctlVer;

                    var width = 0, height = 0;
                    var channels = found.info && found.info.channels;
                    if (channels) {
                        for (var chKey in channels) {
                            if (channels.hasOwnProperty(chKey) && channels[chKey].lcd_info) {
                                width = channels[chKey].lcd_info.screen_width || 0;
                                height = channels[chKey].lcd_info.screen_height || 0;
                                break;
                            }
                        }
                    }

                    var resEl = document.getElementById('device-resolution');
                    var shapeEl = document.getElementById('device-shape');
                    if (width > 0 && height > 0) {
                        resEl.textContent = width + ' \u00D7 ' + height + ' px';
                        var isCircular = name.includes('Kraken') && (width > 240 || height > 240);
                        shapeEl.textContent = isCircular ? 'Circular' : 'Rectangular';
                    } else {
                        resEl.textContent = 'Not available';
                        shapeEl.textContent = 'Unknown';
                    }

                    document.getElementById('device-status').innerHTML =
                        '<span class="device-status connected"><span class="device-status-dot"></span> Connected</span>';
                    contentEl.style.display = 'block';
                } else {
                    document.getElementById('device-name').textContent = '\u2014';
                    document.getElementById('device-uid').textContent = '\u2014';
                    document.getElementById('device-resolution').textContent = '\u2014';
                    document.getElementById('device-shape').textContent = '\u2014';
                    document.getElementById('device-firmware').textContent = '\u2014';
                    document.getElementById('device-liquidctl').textContent = '\u2014';
                    document.getElementById('device-status').innerHTML =
                        '<span class="device-status disconnected"><span class="device-status-dot"></span> No LCD device found</span>';
                    contentEl.style.display = 'block';
                }
            } catch (error) {
                console.warn('Device detection failed:', error);
                loadingEl.style.display = 'none';
                document.getElementById('device-status').innerHTML =
                    '<span class="device-status error"><span class="device-status-dot"></span> Detection failed</span>';
                document.getElementById('device-error-text').textContent =
                    'Could not connect to CoolerControl API (' + error.message + ').';
                contentEl.style.display = 'block';
                errorEl.style.display = 'block';
            }
        }

        function refreshDeviceInfo() {
            fetchDeviceInfo(lastApiAddress, lastApiPassword);
        }

        async function fetchSystemInfo(apiAddress, password) {
            try {
                var headers = {};
                if (password) {
                    headers['Authorization'] = 'Basic ' + btoa('admin:' + password);
                }

                var healthRes = await fetch(apiAddress + '/health', { headers: headers });
                if (healthRes.ok) {
                    var health = await healthRes.json();
                    var ccVersion = (health.details && health.details.version) || '\u2014';
                    document.getElementById('sys-cc-version').textContent = ccVersion;
                }

                var devRes = await fetch(apiAddress + '/devices', { headers: headers });
                if (devRes.ok) {
                    var data = await devRes.json();
                    var devices = data.devices || [];
                    var kernel = '';
                    for (var i = 0; i < devices.length; i++) {
                        var drvType = devices[i].info && devices[i].info.driver_info && devices[i].info.driver_info.drv_type;
                        var ver = devices[i].info && devices[i].info.driver_info && devices[i].info.driver_info.version;
                        if (drvType === 'Kernel' && ver) {
                            kernel = ver;
                            break;
                        }
                    }
                    if (kernel) {
                        document.getElementById('sys-kernel').textContent = kernel;
                    }
                }
            } catch (error) {
                console.warn('System info fetch failed:', error);
            }
        }

        // ===== UI FUNCTIONS =====
        function switchTab(index) {
            var tabs = document.querySelectorAll('.tab');
            var panels = document.querySelectorAll('.panel');
            for (var i = 0; i < tabs.length; i++) {
                tabs[i].classList.toggle('active', i === index);
            }
            for (var j = 0; j < panels.length; j++) {
                panels[j].classList.toggle('active', j === index);
            }
            currentTab = index;
        }

        function toggleCircleInterval() {
            var mode = document.getElementById('display_mode').value;
            document.getElementById('circle_interval_group').style.display = mode === 'circle' ? 'block' : 'none';
            var midSlotGroup = document.getElementById('sensor_slot_mid_group');
            var midBarHeightGroup = document.getElementById('bar_height_mid_group');
            if (midSlotGroup) midSlotGroup.style.display = mode === 'circle' ? 'block' : 'none';
            if (midBarHeightGroup) midBarHeightGroup.style.display = mode === 'circle' ? 'block' : 'none';
            if (mode === 'dual') {
                var midSlot = document.getElementById('sensor_slot_mid');
                if (midSlot) midSlot.value = 'none';
            }
            validateSensorSlots();
        }

        function validateSensorSlots() {
            var mode = document.getElementById('display_mode').value;
            var slotUp = document.getElementById('sensor_slot_up').value;
            var slotMid = document.getElementById('sensor_slot_mid').value;
            var slotDown = document.getElementById('sensor_slot_down').value;

            var warningDiv = document.getElementById('sensor_slot_warning');
            var warningText = document.getElementById('sensor_slot_warning_text');
            var warnings = [];

            var activeSlots = [];
            if (slotUp !== 'none') activeSlots.push({ name: 'Upper', value: slotUp });
            if (mode === 'circle' && slotMid !== 'none') activeSlots.push({ name: 'Middle', value: slotMid });
            if (slotDown !== 'none') activeSlots.push({ name: 'Lower', value: slotDown });

            if (activeSlots.length === 0) warnings.push('At least one sensor slot must be active.');

            var usedSensors = {};
            for (var i = 0; i < activeSlots.length; i++) {
                if (usedSensors[activeSlots[i].value]) {
                    warnings.push('Duplicate: "' + activeSlots[i].value + '" used in ' + usedSensors[activeSlots[i].value] + ' and ' + activeSlots[i].name + '.');
                } else {
                    usedSensors[activeSlots[i].value] = activeSlots[i].name;
                }
            }

            warningDiv.style.display = warnings.length > 0 ? 'block' : 'none';
            warningText.textContent = warnings.join(' ');

            // Ensure sensor configs exist for all active sensors
            ensureSensorConfigsForSlots();

            return warnings.length === 0;
        }

        function updateRangeValue(id, value) {
            document.getElementById(id + '_value').textContent = value + '%';
        }

        function rgbToHex(rgb) {
            var r = Math.round(rgb.r).toString(16).padStart(2, '0');
            var g = Math.round(rgb.g).toString(16).padStart(2, '0');
            var b = Math.round(rgb.b).toString(16).padStart(2, '0');
            return '#' + r + g + b;
        }

        function hexToRgb(hex) {
            var result = /^#?([a-f\d]{2})([a-f\d]{2})([a-f\d]{2})$/i.exec(hex);
            return result ? { r: parseInt(result[1], 16), g: parseInt(result[2], 16), b: parseInt(result[3], 16) } : null;
        }

        function updateColorRGB(colorId, rgbId) {
            var rgb = hexToRgb(document.getElementById(colorId).value);
            if (rgb) document.getElementById(rgbId).textContent = 'RGB(' + rgb.r + ', ' + rgb.g + ', ' + rgb.b + ')';
        }

        function setupColorPicker(colorId, rgbId, rgbObj) {
            var colorInput = document.getElementById(colorId);
            if (rgbObj && colorInput) {
                colorInput.value = rgbToHex(rgbObj);
                var rgbEl = document.getElementById(rgbId);
                if (rgbEl) rgbEl.textContent = 'RGB(' + Math.round(rgbObj.r) + ', ' + Math.round(rgbObj.g) + ', ' + Math.round(rgbObj.b) + ')';
            }
        }

        function getColorFromPicker(colorId) {
            var el = document.getElementById(colorId);
            return el ? hexToRgb(el.value) : null;
        }

        async function loadDefaultConfig() {
            try {
                var response = await fetch('config.json');
                if (!response.ok) throw new Error('HTTP ' + response.status);
                DEFAULT_CONFIG = await response.json();
                return DEFAULT_CONFIG;
            } catch (error) {
                console.error("Failed to load config.json:", error);
                DEFAULT_CONFIG = FACTORY_DEFAULTS;
                return DEFAULT_CONFIG;
            }
        }

        // ===== BUILD CONFIG FROM FORM =====
        function buildConfig() {
            var form = document.getElementById('configForm');
            var formData = new FormData(form);
            var config = {
                daemon: {}, paths: {}, display: {}, layout: {}, colors: {},
                font: {}, sensors: {}, positioning: {}
            };

            var entries = formData.entries();
            var entry;
            while (!(entry = entries.next()).done) {
                var key = entry.value[0];
                var value = entry.value[1];
                var parts = key.split('.');
                if (parts.length === 2 && config[parts[0]] !== undefined) {
                    // Sensor slot values must always be strings
                    var isSlotField = (parts[1] === 'sensor_slot_up' || parts[1] === 'sensor_slot_mid' || parts[1] === 'sensor_slot_down');
                    if (isSlotField) {
                        config[parts[0]][parts[1]] = value;
                    } else {
                        // Strict number check: only convert pure numeric strings
                        var trimmed = value.trim();
                        var isNumeric = trimmed !== '' && /^-?\d+(\.\d+)?$/.test(trimmed);
                        config[parts[0]][parts[1]] = isNumeric ? parseFloat(trimmed) : value;
                    }
                }
            }

            // Global colors
            config.colors.display_background = getColorFromPicker('color_display_background');
            config.colors.bar_background = getColorFromPicker('color_bar_background');
            config.colors.bar_border = getColorFromPicker('color_bar_border');
            config.colors.font_temp = getColorFromPicker('color_font_temp');
            config.colors.font_label = getColorFromPicker('color_font_label');

            // Sensor configs from dynamic form sections
            config.sensors = collectSensorConfigsFromDOM();

            return config;
        }

        // ===== POPULATE FORM FROM CONFIG =====
        function populateForm(config) {
            // Standard form fields (non-sensor, non-color)
            for (var section in config) {
                if (!config.hasOwnProperty(section)) continue;
                if (section === 'sensors' || section === 'colors') continue;
                var fields = config[section];
                if (typeof fields === 'object' && fields !== null) {
                    for (var field in fields) {
                        if (!fields.hasOwnProperty(field)) continue;
                        var value = fields[field];
                        var input = document.querySelector('[name="' + section + '.' + field + '"]');
                        if (input && typeof value !== 'object') {
                            input.value = (typeof value === 'boolean') ? (value ? "1" : "0") : value;
                            if (field === 'brightness') updateRangeValue('brightness', value);
                        }
                    }
                }
            }

            // Sensor slot selects: ensure custom values are available as options
            var slotFields = ['sensor_slot_up', 'sensor_slot_mid', 'sensor_slot_down'];
            var slotDefaults = { sensor_slot_up: 'cpu', sensor_slot_mid: 'liquid', sensor_slot_down: 'gpu' };
            for (var sf = 0; sf < slotFields.length; sf++) {
                var slotValue = config.display && config.display[slotFields[sf]];
                if (slotValue) {
                    // Ensure value is a string (fix legacy numeric corruption)
                    slotValue = String(slotValue);
                    // Reject pure numeric values (corrupt from old parseFloat bug)
                    if (/^\d+$/.test(slotValue)) {
                        slotValue = slotDefaults[slotFields[sf]] || 'cpu';
                        config.display[slotFields[sf]] = slotValue;
                    }
                    var select = document.getElementById(slotFields[sf]);
                    if (select) {
                        var exists = false;
                        for (var oi = 0; oi < select.options.length; oi++) {
                            if (select.options[oi].value === slotValue) { exists = true; break; }
                        }
                        if (!exists && slotValue !== 'none') {
                            var opt = document.createElement('option');
                            opt.value = slotValue;
                            opt.textContent = getSensorDisplayName(slotValue);
                            select.insertBefore(opt, select.firstChild);
                        }
                        select.value = slotValue;
                    }
                }
            }

            // Global colors
            if (config.colors) {
                setupColorPicker('color_display_background', 'rgb_display_background', config.colors.display_background);
                setupColorPicker('color_bar_background', 'rgb_bar_background', config.colors.bar_background);
                setupColorPicker('color_bar_border', 'rgb_bar_border', config.colors.bar_border);
                setupColorPicker('color_font_temp', 'rgb_font_temp', config.colors.font_temp);
                setupColorPicker('color_font_label', 'rgb_font_label', config.colors.font_label);
            }

            // Render dynamic sensor configs
            currentSensorConfig = config.sensors || {};
            renderSensorConfigs(config);

            toggleCircleInterval();
            validateSensorSlots();
        }

        // ===== SAVE / RESET / EXPORT =====
        async function saveConfig() {
            if (!validateSensorSlots()) {
                alert("Please fix sensor slot warnings before saving.");
                return;
            }

            var config = buildConfig();
            try {
                await writeConfigToFile(config);
                requestRestartAfterSave(1000);
                await savePluginConfig(config);
                alert("Configuration saved! Plugin will restart.");
                setTimeout(function() { window.close(); }, 300);
            } catch (error) {
                console.error("Save failed:", error);
                alert("Save failed: " + error.message);
            }
        }

        function exportConfig() {
            try {
                var config = buildConfig();
                var jsonStr = JSON.stringify(config, null, 2);
                var blob = new Blob([jsonStr], { type: 'application/json' });
                var url = URL.createObjectURL(blob);
                var a = document.createElement('a');
                a.href = url;
                var date = new Date().toISOString().slice(0, 10);
                a.download = 'coolerdash-config-backup-' + date + '.json';
                document.body.appendChild(a);
                a.click();
                document.body.removeChild(a);
                URL.revokeObjectURL(url);
            } catch (error) {
                console.error("Export failed:", error);
                alert("Export failed: " + error.message);
            }
        }

        async function restartPluginDaemon(config) {
            try {
                var apiAddress = (config.daemon && config.daemon.address) || 'http://localhost:11987';
                var password = (config.daemon && config.daemon.password) || '';
                var headers = { 'Content-Type': 'application/json' };
                if (password) headers['Authorization'] = 'Basic ' + btoa('admin:' + password);

                var response = await fetch(apiAddress + '/plugins/coolerdash/restart', { method: 'POST', headers: headers });
                if (!response.ok) console.warn("Could not restart plugin automatically");
            } catch (error) {
                console.error("Plugin restart failed:", error);
            }
        }

        function requestRestartAfterSave(delayMs) {
            delayMs = delayMs || 800;
            var doRestart = function() {
                try {
                    if (typeof restart === 'function') restart();
                    else restartPluginDaemon(buildConfig());
                } catch (e) { console.warn('Restart failed:', e); }
            };

            if (typeof successfulConfigSaveCallback === 'function') {
                successfulConfigSaveCallback(function() { setTimeout(doRestart, delayMs); });
            } else {
                var handler = function(event) {
                    if (event.data && event.data.type === 'configSaved') {
                        window.removeEventListener('message', handler);
                        setTimeout(doRestart, delayMs);
                    }
                };
                window.addEventListener('message', handler);
            }
        }

        async function writeConfigToFile(config) {
            try {
                var apiAddress = (config.daemon && config.daemon.address) || 'http://localhost:11987';
                var password = (config.daemon && config.daemon.password) || '';

                if (password) {
                    var response = await fetch(apiAddress + '/plugins/coolerdash/config', {
                        method: 'PUT',
                        headers: { 'Content-Type': 'application/json', 'Authorization': 'Basic ' + btoa('admin:' + password) },
                        body: JSON.stringify(config, null, 2)
                    });
                    if (response.ok) return true;
                }

                var blob = new Blob([JSON.stringify(config, null, 2)], { type: 'application/json' });
                var a = document.createElement('a');
                a.href = URL.createObjectURL(blob);
                a.download = 'config.json';
                a.click();
                URL.revokeObjectURL(a.href);
                return false;
            } catch (error) {
                console.warn("Config write failed:", error);
                return false;
            }
        }

        async function resetConfig() {
            try {
                await writeConfigToFile(FACTORY_DEFAULTS);
                populateForm(FACTORY_DEFAULTS);
                requestRestartAfterSave(1000);
                await savePluginConfig(FACTORY_DEFAULTS);
                alert('Reset to factory defaults! Plugin will restart.');
                setTimeout(function() { window.close(); }, 300);
            } catch (error) {
                console.error("Reset failed:", error);
                alert('Reset failed: ' + error.message);
            }
        }

        // ===== LEGACY CONFIG MIGRATION =====
        function migrateConfig(config) {
            var sensors = config.sensors || {};
            var needsMigration = false;

            // Detect legacy format: top-level cpu/gpu/liquid sections
            if (!config.sensors && (config.cpu || config.gpu || config.liquid)) {
                needsMigration = true;
                if (config.cpu) sensors.cpu = config.cpu;
                if (config.gpu) sensors.gpu = config.gpu;
                if (config.liquid) sensors.liquid = config.liquid;

                // Migrate per-sensor positioning offsets
                if (config.positioning) {
                    if (sensors.cpu) {
                        sensors.cpu.offset_x = config.positioning.temp_offset_x_cpu || 0;
                        sensors.cpu.offset_y = config.positioning.temp_offset_y_cpu || 0;
                    }
                    if (sensors.gpu) {
                        sensors.gpu.offset_x = config.positioning.temp_offset_x_gpu || 0;
                        sensors.gpu.offset_y = config.positioning.temp_offset_y_gpu || 0;
                    }
                    if (sensors.liquid) {
                        sensors.liquid.offset_x = config.positioning.temp_offset_x_liquid || 0;
                        sensors.liquid.offset_y = config.positioning.temp_offset_y_liquid || 0;
                    }
                }
            }

            // Build merged config
            var merged = {
                daemon: Object.assign({}, DEFAULT_CONFIG.daemon, config.daemon || {}),
                paths: Object.assign({}, DEFAULT_CONFIG.paths, config.paths || {}),
                display: Object.assign({}, DEFAULT_CONFIG.display, config.display || {}),
                layout: Object.assign({}, DEFAULT_CONFIG.layout, config.layout || {}),
                colors: Object.assign({}, DEFAULT_CONFIG.colors, config.colors || {}),
                font: Object.assign({}, DEFAULT_CONFIG.font, config.font || {}),
                sensors: Object.assign({}, DEFAULT_CONFIG.sensors || {}),
                positioning: Object.assign({}, DEFAULT_CONFIG.positioning, config.positioning || {})
            };

            // Deep merge sensor configs (skip corrupt numeric keys)
            for (var id in sensors) {
                if (!sensors.hasOwnProperty(id)) continue;
                // Remove corrupt numeric sensor IDs from old parseFloat bug
                if (/^\d+$/.test(id)) continue;
                var defaults = merged.sensors[id] || getDefaultSensorConfig(id);
                merged.sensors[id] = Object.assign({}, defaults, sensors[id]);
                // Deep merge color objects
                var colorKeys = ['threshold_1_color', 'threshold_2_color', 'threshold_3_color', 'threshold_4_color'];
                for (var c = 0; c < colorKeys.length; c++) {
                    if (sensors[id][colorKeys[c]]) {
                        merged.sensors[id][colorKeys[c]] = Object.assign({}, defaults[colorKeys[c]] || {}, sensors[id][colorKeys[c]]);
                    }
                }
            }

            // Sanitize corrupt numeric slot values (from old parseFloat bug)
            var slotDefaults = { sensor_slot_up: 'cpu', sensor_slot_mid: 'liquid', sensor_slot_down: 'gpu' };
            for (var slotKey in slotDefaults) {
                if (merged.display && merged.display[slotKey] !== undefined) {
                    var sv = String(merged.display[slotKey]);
                    if (/^\d+$/.test(sv)) {
                        merged.display[slotKey] = slotDefaults[slotKey];
                    } else {
                        merged.display[slotKey] = sv;
                    }
                }
            }

            // Clean up legacy positioning keys
            delete merged.positioning.temp_offset_x_cpu;
            delete merged.positioning.temp_offset_x_gpu;
            delete merged.positioning.temp_offset_y_cpu;
            delete merged.positioning.temp_offset_y_gpu;
            delete merged.positioning.temp_offset_x_liquid;
            delete merged.positioning.temp_offset_y_liquid;

            // Remove legacy top-level sensor sections
            delete merged.cpu;
            delete merged.gpu;
            delete merged.liquid;

            return merged;
        }

        // ===== INITIALIZATION =====
        runPluginScript(async function() {
            try {
                await loadDefaultConfig();
                var config = await getPluginConfig();

                if (!config || Object.keys(config).length === 0) {
                    config = JSON.parse(JSON.stringify(DEFAULT_CONFIG));
                } else {
                    config = migrateConfig(config);
                }

                populateForm(config);

                // Detect device and discover sensors from CoolerControl API
                var apiAddr = (config.daemon && config.daemon.address) || 'http://localhost:11987';
                var apiPass = (config.daemon && config.daemon.password) || '';
                fetchDeviceInfo(apiAddr, apiPass);
                fetchSystemInfo(apiAddr, apiPass);
                discoverSensors(apiAddr, apiPass);
            } catch (error) {
                console.error("Init failed:", error);
                if (DEFAULT_CONFIG) populateForm(DEFAULT_CONFIG);
            }
        });
    </script>
</body>
</html>
